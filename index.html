<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Phòng Thí Nghiệm Vật Lí Ảo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #1a1a2e, #2c2c3e);
      color: #f1f1f1;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h2 {
      margin: 20px 0;
      color: #ffcc00;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
      font-weight: 600;
    }
    .container {
      margin: 20px auto;
      max-width: 900px;
      background: rgba(47, 47, 61, 0.7);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    canvas {
      background: #333642;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }
    .controls, #params {
      margin: 10px 0;
      padding: 15px;
      background: #3b3b4d;
      border-radius: 10px;
    }
    #params {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px 20px;
    }
    .param-item {
      display: flex;
      align-items: center;
      min-width: 380px;
    }
    select {
      margin: 5px;
      padding: 5px;
      border-radius: 6px;
      border: none;
      background: #555;
      color: #fff;
      font-family: 'Poppins', sans-serif;
    }
    button {
      margin: 5px;
      padding: 8px 18px;
      border-radius: 8px;
      border: none;
      background: #e67e22;
      color: #fff;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
    }
    button:hover {
      background: #d35400;
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
    }
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 150px;
      height: 8px;
      background: #555;
      border-radius: 5px;
      outline: none;
      margin: 0 10px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #e67e22;
      cursor: pointer;
      border-radius: 50%;
    }
    .formula {
      margin: 15px 0;
      font-size: 1.1em;
      color: #ffd54f;
    }
    #info {
      margin-top: 15px;
      padding: 12px;
      background: #3b3b4d;
      border-radius: 10px;
      font-size: 1em;
      text-align: left;
      line-height: 1.5;
    }
    .slider-label {
      width: 180px;
      text-align: right;
      font-size: 0.9em;
    }
    .slider-value {
      min-width: 40px; text-align: left;
    }
    .simulation-area {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    #canvas {
      flex-shrink: 0;
    }
    .chart-container {
      flex-grow: 1; min-width: 200px; background: #3b3b4d; border-radius: 10px; padding: 10px; margin-top: 20px;
    }
  </style>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <h2>Phòng Thí Nghiệm Vật Lí Ảo <br><span style="font-size:0.6em;">(Ver 1.0 - By Developer Anh Viet)</span></h2>
  <div class="container">
    <div class="controls">
      <label>Chọn thí nghiệm:
        <select id="experiment" onchange="changeExperiment()">
          <option value="pendulum">Con lắc đơn</option>
          <option value="spring">Lò xo</option>
          <option value="projectile">Chuyển động ném ngang</option>
          <option value="ideal_gas">Khí lý tưởng</option>
          <option value="thermo">Nhiệt động lực học</option>
          <option value="spring_horizontal">Con lắc lò xo ngang</option>
          <option value="inclined_plane">Mặt phẳng nghiêng</option>
        </select>
      </label>
      <button onclick="resetExperiment()">Khởi động lại</button>
      <button onclick="togglePause()" id="pauseBtn">Tạm dừng</button>
      <button onclick="speedUp()">Tua nhanh</button>
      <button onclick="speedDown()">Tua chậm</button>
      <button onclick="toggleHeating()" id="heatBtn">Bật lửa</button>
    </div>
    <div id="params"></div>
    <div class="formula" id="formula"></div>
    <div class="simulation-area">
        <canvas id="canvas" width="700" height="450"></canvas>
        <div class="chart-container">
            <canvas id="energyChart"></canvas>
        </div>
    </div>
    <div id="info"></div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let experiment = 'pendulum';
        let isPaused = false;
        let speed = 1;
        let energyChart;
        let chartData = { KE: [], PE: [], E: [], labels: [] };
        const timeStep = 0.016; // ~60 FPS

        // --- Con lắc đơn ---
        let pendulum = {
            length: 1, // mét
            angle: Math.PI / 6, // rad
            damping: 0.1, // Hệ số cản
            aVel: 0, aAcc: 0,
            gravity: 9.81, // m/s^2
            origin: { x: 350, y: 60 },
            mass: 0.2 // kg
        };

        // --- Lò xo ---
        let spring = {
            k: 20, // N/m
            mass: 0.5, // kg
            amplitude: 0.2, // mét
            damping: 0.2, // Hệ số cản
            t: 0 // thời gian mô phỏng
        };

        // --- Ném ngang ---
        let projectile = {
            x: 60, y: 60,
            vx: 10, // m/s
            damping: 0.01, // Hệ số cản
            vy: 0,
            g: 9.81, // m/s^2
            radius: 15,
            ground: 430, // pixel
            t: 0, // thời gian mô phỏng
            h0: 4, // mét
            mass: 0.1 // kg
        };

        // --- Khí lý tưởng ---
        let idealGas = {
            P: 101325, // Pa
            V: 0.0224, // m³
            n: 1, // mol
            T: 273, // K
            R: 8.314, // J/mol.K
            box: { x: 230, y: 100, w: 240, h: 200 },
            M: 0.028, // kg/mol (Khí N2)
            molecules: []
        };

        // --- Nhiệt động lực học ---
        let thermo = {
            Q: 0, // J
            m: 1, // kg
            c: 4200, // J/kg.K
            c_water: 4200, // Nhiệt dung riêng của nước
            c_ice: 2100,   // Nhiệt dung riêng của đá
            Lf: 334000,  // Ẩn nhiệt nóng chảy (J/kg)
            Lv: 2260000, // Ẩn nhiệt hóa hơi (J/kg)
            T0: 25, // °C
            T: 25, // °C
            heating: false,
            state: 'LIQUID', // SOLID, LIQUID, GAS, MELTING, BOILING
            lastUpdate: 0,
            m_container: 0.5, // kg
            c_container: 900,  // J/kg.K (Nhôm)
            t: 0 // Thời gian mô phỏng
        };

        // --- Con lắc lò xo ngang ---
        let spring_horizontal = {
            k: 20, // N/m
            mass: 0.5, // kg
            amplitude: 0.2, // m
            damping: 0.2, // Hệ số cản
            x0: 350, // px
            t: 0 // thời gian mô phỏng
        };

        // --- Mặt phẳng nghiêng ---
        let inclined_plane = {
            angle: 30, // độ
            mass: 1, // kg
            g: 9.81,
            friction: 0.1, // Hệ số ma sát
            s: 0, // Quãng đường đi được (m)
            v: 0, t: 0 // Vận tốc (m/s), thời gian (s)
        };

        // --- Khởi tạo phân tử khí ---
        function initMolecules() {
            idealGas.molecules = [];
            let count = Math.min(Math.round(idealGas.n * 50), 100);
            for (let i = 0; i < count; i++) {
                idealGas.molecules.push({
                    x: idealGas.box.x + 10 + Math.random() * (idealGas.box.w - 20),
                    y: idealGas.box.y + 10 + Math.random() * (idealGas.box.h - 20),
                    vx: (idealGas.T > 0 ? (Math.random() - 0.5) * Math.sqrt(idealGas.T) * 0.1 : 0),
                    vy: (idealGas.T > 0 ? (Math.random() - 0.5) * Math.sqrt(idealGas.T) * 0.1 : 0)
                });
            }
        }

        // --- Vẽ con lắc đơn ---
        function drawPendulum() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let pxLength = pendulum.length * 150; // chuyển mét sang px
            let x = pendulum.origin.x + pxLength * Math.sin(pendulum.angle);
            let y = pendulum.origin.y + pxLength * Math.cos(pendulum.angle);
            ctx.beginPath();
            ctx.moveTo(pendulum.origin.x, pendulum.origin.y);
            ctx.lineTo(x, y);
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, 2 * Math.PI);
            ctx.fillStyle = "#ffb300";
            ctx.shadowColor = "#ffb300";
            ctx.shadowBlur = 15;
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.beginPath();
            ctx.arc(pendulum.origin.x, pendulum.origin.y, 8, 0, 2 * Math.PI);
            ctx.fillStyle = "#fff";
            ctx.fill();
        }

        function updatePendulum() {
            pendulum.aAcc = (-pendulum.gravity / pendulum.length) * Math.sin(pendulum.angle);
            let dampingForce = -pendulum.damping * pendulum.aVel;
            pendulum.aVel += (pendulum.aAcc + dampingForce) * timeStep;
            pendulum.angle += pendulum.aVel * timeStep;
        }

        // --- Vẽ lò xo ---
        function drawSpring() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let omega = Math.sqrt(spring.k / spring.mass);
            // Thêm hệ số tắt dần vào biên độ
            let current_amplitude = spring.amplitude * Math.exp(-(spring.damping / (2 * spring.mass)) * spring.t);
            let y = 200 + current_amplitude * Math.cos(omega * spring.t) * 300;
            ctx.beginPath();
            ctx.moveTo(350, 50);
            ctx.lineTo(350, y - 20);
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 6;
            ctx.stroke();
            ctx.beginPath();
            ctx.rect(320, y - 20, 60, 40);
            ctx.fillStyle = "#ffb300";
            ctx.shadowColor = "#ffb300";
            ctx.shadowBlur = 15;
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.beginPath();
            ctx.arc(350, 50, 8, 0, 2 * Math.PI);
            ctx.fillStyle = "#fff";
            ctx.fill();
        }

        function updateSpring() {
            spring.t += timeStep;
        }

        // --- Vẽ con lắc lò xo ngang ---
        function drawSpringHorizontal() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let omega = Math.sqrt(spring_horizontal.k / spring_horizontal.mass);
            // Thêm hệ số tắt dần vào biên độ
            let current_amplitude = spring_horizontal.amplitude * Math.exp(-(spring_horizontal.damping / (2 * spring_horizontal.mass)) * spring_horizontal.t);
            let x = spring_horizontal.x0 + current_amplitude * Math.cos(omega * spring_horizontal.t) * 300;
            ctx.beginPath();
            ctx.moveTo(150, 225);
            ctx.lineTo(x, 225);
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 6;
            ctx.stroke();
            ctx.beginPath();
            ctx.rect(x, 205, 40, 40);
            ctx.fillStyle = "#ffb300";
            ctx.fill();
        }

        function updateSpringHorizontal() {
            spring_horizontal.t += timeStep;
        }

        // --- Vẽ ném ngang ---
        function drawProjectile() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.moveTo(0, projectile.ground);
            ctx.lineTo(canvas.width, projectile.ground);
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(projectile.x, projectile.y, projectile.radius, 0, 2 * Math.PI);
            ctx.fillStyle = "#ffb300";
            ctx.shadowColor = "#ffb300";
            ctx.shadowBlur = 15;
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function updateProjectile() {
            const scale = 40; // 40px = 1m
            if (projectile.y + projectile.radius < projectile.ground) {
                projectile.t += timeStep * speed;
                // Cập nhật vận tốc với lực cản
                projectile.vy += projectile.g * timeStep * speed;
                projectile.vx -= projectile.damping * projectile.vx * timeStep * speed;
                projectile.vy -= projectile.damping * projectile.vy * timeStep * speed;
                // Cập nhật vị trí
                projectile.x += projectile.vx * timeStep * speed * scale;
                projectile.y += projectile.vy * timeStep * speed * scale;
            }
        }

        // --- Khí lý tưởng ---
        function drawIdealGas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 3;
            ctx.strokeRect(idealGas.box.x, idealGas.box.y, idealGas.box.w, idealGas.box.h);
            // Vẽ piston. 0.1 là giá trị max của slider V, tương ứng với chiều cao tối đa của hộp.
            let maxVolumeDisplay = 0.1; 
            let pistonY = idealGas.box.y + idealGas.box.h - (idealGas.V / 0.1 * idealGas.box.h);
            ctx.fillStyle = "#aaa";
            ctx.fillRect(idealGas.box.x, pistonY, idealGas.box.w, 10);
            
            idealGas.molecules.forEach(mol => {
                ctx.beginPath();
                ctx.arc(mol.x, mol.y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = idealGas.T > 0 ? "#ffb300" : "#888";
                ctx.fill();
            });
        }

        function updateIdealGas() {
            if (isPaused) return;
            let maxVolumeDisplay = 0.1;
            let pistonY = idealGas.box.y + idealGas.box.h - (idealGas.V / maxVolumeDisplay * idealGas.box.h);
            if (idealGas.T <= 0) { // Dừng chuyển động và cho rơi xuống đáy khi T=0K
                idealGas.molecules.forEach(mol => {
                    const bottomY = idealGas.box.y + idealGas.box.h - 5;
                    if (mol.y < bottomY) {
                        mol.y += 1; // Mô phỏng trọng lực
                        if (mol.y > bottomY) mol.y = bottomY; // Đảm bảo không lún qua đáy
                    }
                    mol.vx = 0; mol.vy = 0;
                });
                return;
            }

            idealGas.molecules.forEach(mol => {
                mol.x += mol.vx * speed;
                mol.y += mol.vy * speed;
                // Va chạm với tường trái/phải
                if (mol.x < idealGas.box.x + 5) {
                    mol.x = idealGas.box.x + 5; // Ngăn không cho dính vào tường
                    mol.vx *= -1;
                } else if (mol.x > idealGas.box.x + idealGas.box.w - 5) {
                    mol.x = idealGas.box.x + idealGas.box.w - 5; // Ngăn không cho dính vào tường
                    mol.vx *= -1;
                }
                // Va chạm với tường trên
                if (mol.y < idealGas.box.y + 5) {
                    mol.y = idealGas.box.y + 5; // Ngăn không cho dính vào tường
                    mol.vy *= -1;
                }
                // Va chạm với piston (ranh giới dưới của khí)
                if (mol.y > pistonY - 5) { // Nếu tâm phân tử vượt quá bề mặt piston (trừ bán kính)
                    mol.y = pistonY - 5; // Đặt lại vị trí ngay trên bề mặt piston
                    mol.vy *= -1;
                }

            });
        }

        // --- Vẽ nhiệt động lực học ---
        function drawThermo() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Vẽ bình chứa
            ctx.save();
            ctx.beginPath();
            ctx.arc(350, 250, 70, Math.PI, 2 * Math.PI);
            ctx.lineTo(420, 350);
            ctx.arc(350, 350, 70, 0, Math.PI);
            ctx.arc(350, 350, 70, 0, Math.PI); // Đáy bình
            ctx.lineTo(280, 250);
            ctx.arc(350, 250, 70, Math.PI, 2*Math.PI); // Miệng bình
            ctx.closePath();
            ctx.fillStyle = "#2196f3";
            ctx.fill();
            ctx.clip(); // Giới hạn vùng vẽ bên trong bình

            // Vẽ trạng thái vật chất
            if (thermo.state === 'SOLID' || thermo.state === 'MELTING') {
                ctx.fillStyle = "rgba(173, 216, 230, 0.8)"; // Màu đá
                ctx.fillRect(280, 250, 140, 100);
                // Vẽ các đường nứt cho đá
                ctx.strokeStyle = "rgba(255, 255, 255, 0.4)";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(300, 280); ctx.lineTo(380, 320);
                ctx.moveTo(360, 260); ctx.lineTo(320, 340);
                ctx.stroke();
            }
            if (thermo.state === 'LIQUID' || thermo.state === 'MELTING' || thermo.state === 'BOILING') {
                ctx.fillStyle = "#2196f3"; // Màu nước
                ctx.fillRect(280, 250, 140, 100);
            }
            ctx.restore(); // Bỏ giới hạn clip

            // Vẽ lại đường viền bình
            ctx.beginPath();
            ctx.arc(350, 350, 70, 0, Math.PI); ctx.lineTo(280, 250);
            ctx.arc(350, 250, 70, Math.PI, 2*Math.PI); ctx.closePath();
            ctx.strokeStyle = "#ccc"; ctx.lineWidth = 2; ctx.stroke();

            // Vẽ nhiệt kế
            ctx.fillStyle = "#fff";
            ctx.fillRect(520, 170, 12, 120);
            ctx.fillRect(520, 150, 12, 160); // Thân nhiệt kế dài hơn
            ctx.beginPath();
            ctx.arc(526, 290, 16, 0, 2 * Math.PI);
            ctx.arc(526, 310, 16, 0, 2 * Math.PI); // Bầu nhiệt kế
            ctx.fill();

            // Cột thủy ngân, map từ -50°C đến 150°C
            let tempH = Math.max(0, Math.min((thermo.T + 50) / 200 * 160, 160));
            ctx.fillStyle = "#ff4e50";
            ctx.fillRect(522, 310 - tempH, 8, tempH);

            // Hiệu ứng
            if (thermo.heating) {
                ctx.beginPath();
                ctx.arc(350, 370, 20, 0, Math.PI, true);
                ctx.fillStyle = "#ffb300";
                ctx.fill();
            }
            if (thermo.T >= 100) {
                for (let i = 0; i < 10; i++) {
                    let bx = 310 + Math.random() * 80;
                    let by = 250 + Math.random() * 80; // Bong bóng trong vùng nước
                    ctx.beginPath();
                    ctx.arc(bx, by, 4, 0, 2 * Math.PI);
                    ctx.fillStyle = "rgba(255,255,255,0.7)";
                    ctx.fill();
                }
            }
        }

        function updateThermo() {
            let now = Date.now();
            let dt = (now - (thermo.lastUpdate || now)) / 1000;
            thermo.lastUpdate = now;
            thermo.t += dt * speed;

            let energyChange = 0;
            if (thermo.heating) {
                energyChange = 500 * dt * speed; // 500W, ảnh hưởng bởi speed
            } else {
                // Tỏa nhiệt ra môi trường (Newton's law of cooling)
                energyChange = -thermo.m * 40 * (thermo.T - 20) * dt * speed; // 20 là nhiệt độ môi trường
            }
            thermo.Q += energyChange;

            // Xử lý các trạng thái
            switch(thermo.state) {
                case 'SOLID': {
                    const totalHeatCapacity = (thermo.m * thermo.c_ice) + (thermo.m_container * thermo.c_container);
                    thermo.T += energyChange / totalHeatCapacity;
                    if (thermo.T >= 0) { thermo.T = 0; thermo.state = 'MELTING'; }
                    break;
                }
                case 'MELTING': {
                    // Nhiệt độ không đổi, chỉ có nhiệt lượng thay đổi
                    if (thermo.Q > thermo.m * thermo.Lf) {
                        thermo.Q = thermo.Q - thermo.m * thermo.Lf;
                        thermo.state = 'LIQUID';
                    } else if (thermo.Q < 0) {
                        thermo.Q = 0;
                        thermo.state = 'SOLID';
                    }
                    break;
                }
                case 'LIQUID': {
                    const totalHeatCapacity = (thermo.m * thermo.c_water) + (thermo.m_container * thermo.c_container);
                    thermo.T += energyChange / totalHeatCapacity;
                    if (thermo.T >= 100) {
                        thermo.Q = (thermo.T - 100) * thermo.m * thermo.c_water;
                        thermo.T = 100;
                        thermo.state = 'BOILING';
                    } else if (thermo.T < 0) {
                        thermo.Q = thermo.T * thermo.m * thermo.c_water;
                        thermo.T = 0;
                        thermo.state = 'MELTING';
                    }
                    break;
                }
                case 'BOILING': {
                     if (thermo.Q > thermo.m * thermo.Lv) {
                        thermo.state = 'GAS'; // Toàn bộ đã hóa hơi
                    } else if (thermo.Q < 0) {
                        thermo.Q = 0;
                        thermo.state = 'LIQUID';
                    }
                    break;
                }
                case 'GAS':
                    // Có thể thêm logic cho hơi nước siêu nhiệt ở đây
                    break;
            }
        }

        // --- Vẽ mặt phẳng nghiêng ---
        function drawInclinedPlane() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let rad = inclined_plane.angle * Math.PI / 180;
            const scale = 40; // 40px = 1m
            // Vẽ mặt phẳng nghiêng
            const startX = 150, startY = 400;
            const endX = 600;
            const endY = startY - Math.tan(rad) * (endX - startX);
            const planeLengthPx = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 8;
            ctx.stroke();

            // Vật nặng
            let current_s_px = inclined_plane.s * scale;
            let current_x = startX + current_s_px * Math.cos(rad);
            let current_y = startY - current_s_px * Math.sin(rad);

            ctx.save();
            ctx.translate(current_x, current_y);
            ctx.rotate(-rad);
            ctx.fillStyle = "#fff874";
            ctx.fillRect(-20, -20, 40, 40);
            ctx.restore();
        }
        function updateInclinedPlane() {
            const planeLengthM = (600 - 150) / 40 / Math.cos(inclined_plane.angle * Math.PI / 180);
            let rad = inclined_plane.angle * Math.PI / 180;
            if (inclined_plane.s < planeLengthM) {
                let a_g = inclined_plane.g * Math.sin(rad);
                let a_f = -inclined_plane.friction * inclined_plane.g * Math.cos(rad);
                let a = (a_g + a_f > 0) ? a_g + a_f : 0; // Gia tốc không thể âm (vật không tự đi ngược)
                inclined_plane.v += a * timeStep * speed;
                inclined_plane.s += inclined_plane.v * timeStep * speed;
                inclined_plane.t += timeStep * speed;
            }
        }

        // --- Hiển thị công thức ---
        function showFormula() {
            let html = '';
            if (experiment === 'pendulum') {
                html = '\\( \\theta(t) = \\theta_0 \\cos\\left(\\sqrt{\\frac{g}{l}} t\\right) \\) &nbsp; &nbsp; \\( T = 2\\pi \\sqrt{\\frac{l}{g}} \\)';
            } else if (experiment === 'spring') {
                html = '\\( x(t) = A \\cos(\\omega t) \\), &nbsp; \\( \\omega = \\sqrt{\\frac{k}{m}} \\)';
            } else if (experiment === 'projectile') { // Công thức y đã được sửa
                html = '\\( x(t) = v_0 t \\), &nbsp; \\( y(t) = h_0 - \\frac{1}{2}gt^2 \\)';
            } else if (experiment === 'ideal_gas') {
                html = '\\( PV = nRT \\)';
            } else if (experiment === 'thermo') {
                html = '\\( Q = m c \\Delta T \\)';
            }
            document.getElementById('formula').innerHTML = html;
            if (window.MathJax) MathJax.typesetPromise();
        }

        // --- Tính toán phân bố Maxwell-Boltzmann ---
        function getMaxwellBoltzmannDistribution(T, M) {
            const R = 8.314;
            const k = 4 * Math.PI * Math.pow(M / (2 * Math.PI * R * T), 1.5);
            const exponent_factor = -M / (2 * R * T);
            
            let velocities = [];
            let probabilities = [];
            for (let v = 0; v <= 1500; v += 50) { // Vận tốc từ 0 đến 1500 m/s
                velocities.push(v);
                probabilities.push(k * v * v * Math.exp(exponent_factor * v * v));
            }
            return { velocities, probabilities };
        }

        // --- Hiển thị thông số ---
        function showInfo() {
            let html = '';
            if (experiment === 'pendulum') {
                let h = pendulum.length * (1 - Math.cos(pendulum.angle)); // Độ cao so với vị trí cân bằng
                let PE = pendulum.mass * pendulum.gravity * h; // Thế năng
                let v = pendulum.length * pendulum.aVel; // Vận tốc
                let KE = 0.5 * pendulum.mass * v * v; // Động năng
                let E = KE + PE;
                html = `
                    <b>Con lắc đơn:</b><br>
                    Góc hiện tại: ${(pendulum.angle * 180 / Math.PI).toFixed(2)}°<br>
                    Độ dài: ${pendulum.length.toFixed(2)} m<br>
                    Khối lượng: ${pendulum.mass} kg<br>
                    Vận tốc góc: ${pendulum.aVel.toFixed(3)} rad/s<br>
                    Gia tốc góc: ${pendulum.aAcc.toFixed(3)} rad/s²<br>
                    Chu kỳ: ${(2 * Math.PI * Math.sqrt(pendulum.length / pendulum.gravity)).toFixed(2)} s<br>
                    Động năng (KE): ${KE.toFixed(3)} J<br>
                    Thế năng (PE): ${PE.toFixed(3)} J<br>
                    Năng lượng (E): ${E.toFixed(3)} J
                `;
            } else if (experiment === 'spring') {
                let omega = Math.sqrt(spring.k / spring.mass);
                // Tính toán với biên độ tắt dần để khớp với đồ thị và mô phỏng
                let current_amplitude = spring.amplitude * Math.exp(-(spring.damping / (2 * spring.mass)) * spring.t);
                let x = current_amplitude * Math.cos(omega * spring.t);
                // Vận tốc cũng phải được tính từ đạo hàm của li độ tắt dần
                let v = -Math.exp(-(spring.damping / (2 * spring.mass)) * spring.t) * ( (spring.damping / (2 * spring.mass)) * spring.amplitude * Math.cos(omega * spring.t) + omega * spring.amplitude * Math.sin(omega * spring.t) );
                let KE = 0.5 * spring.mass * v * v; 
                let PE = 0.5 * spring.k * x * x;
                let E = KE + PE;
                html = `
                    <b>Lò xo:</b><br>
                    Thời gian: ${spring.t.toFixed(2)} s<br>
                    Độ cứng k: ${spring.k} N/m<br>
                    Khối lượng: ${spring.mass} kg<br>
                    Biên độ: ${spring.amplitude.toFixed(2)} m<br>
                    Tần số góc: ${omega.toFixed(2)} rad/s<br>
                    Vị trí x: ${x.toFixed(2)} m<br>
                    Vận tốc: ${v.toFixed(2)} m/s<br>
                    Động năng (KE): ${KE.toFixed(3)} J<br>
                    Thế năng (PE): ${PE.toFixed(3)} J<br>
                    Năng lượng (E): ${E.toFixed(3)} J
                `;
            } else if (experiment === 'projectile') {
                let t = projectile.t;
                const scale = 40;
                let current_h = (projectile.ground - projectile.y) / scale;
                let v_total = Math.sqrt(projectile.vx*projectile.vx + projectile.vy*projectile.vy);
                let KE = 0.5 * projectile.mass * v_total * v_total;
                let PE = projectile.mass * projectile.g * Math.max(0, current_h);
                html = `
                    <b>Ném ngang:</b><br>
                    Thời gian bay (t): ${t.toFixed(2)} s<br>
                    Tầm xa (x): ${(projectile.vx * t).toFixed(2)} m<br>
                    Độ cao (y): ${Math.max(0, current_h).toFixed(2)} m<br>
                    Vận tốc ngang (v_x): ${projectile.vx.toFixed(2)} m/s<br>
                    Vận tốc dọc (v_y): ${projectile.vy.toFixed(2)} m/s<br>
                    Động năng (KE): ${KE.toFixed(3)} J<br>
                    Thế năng (PE): ${PE.toFixed(3)} J<br>
                    Năng lượng (E): ${(KE + PE).toFixed(3)} J
                `;
            } else if (experiment === 'ideal_gas') {
                let v_avg = idealGas.T > 0 ? Math.sqrt(3 * idealGas.R * idealGas.T / (idealGas.M)) : 0;
                html = `
                    <b>Khí lý tưởng:</b><br>
                    Áp suất (P): ${(idealGas.P / 1000).toFixed(2)} kPa<br>
                    Thể tích (V): ${idealGas.V.toFixed(2)} m³<br>
                    Số mol (n): ${idealGas.n}<br>
                    Nhiệt độ (T): ${idealGas.T} K<br>
                    Số phân tử (mô phỏng): ${idealGas.molecules.length}<br>
                    Vận tốc trung bình phân tử: ${v_avg.toFixed(2)} m/s
                `;
            } else if (experiment === 'thermo') {
                let stateText = "Lỏng";
                if (thermo.state === 'SOLID') stateText = "Rắn (Nước đá)";
                else if (thermo.state === 'MELTING') stateText = `Nóng chảy (tại 0°C)`;
                else if (thermo.state === 'BOILING') stateText = `Sôi (tại 100°C)`;
                else if (thermo.state === 'GAS') stateText = "Khí (Hơi nước)";

                html = `
                    <b>Nhiệt động lực học:</b><br>
                    Nhiệt lượng trao đổi (Q): ${thermo.Q.toFixed(0)} J<br>
                    Nhiệt độ hiện tại (T): ${thermo.T.toFixed(2)} °C<br>
                    Trạng thái: <strong>${stateText}</strong><br>
                    ---<br>
                    Khối lượng vật (m): ${thermo.m} kg<br>
                    Khối lượng bình (m_b): ${thermo.m_container} kg<br>
                    Nhiệt dung riêng bình (c_b): ${thermo.c_container} J/kg.K<br>
                    Nhiệt dung riêng nước (c_n): ${thermo.c_water} J/kg.K
                `;
            } else if (experiment === 'spring_horizontal') {
                let omega = Math.sqrt(spring_horizontal.k / spring_horizontal.mass);
                // Tính toán với biên độ tắt dần để khớp với đồ thị và mô phỏng
                let current_amplitude = spring_horizontal.amplitude * Math.exp(-(spring_horizontal.damping / (2 * spring_horizontal.mass)) * spring_horizontal.t);
                let x = current_amplitude * Math.cos(omega * spring_horizontal.t);
                // Vận tốc cũng phải được tính từ đạo hàm của li độ tắt dần
                let v = -Math.exp(-(spring_horizontal.damping / (2 * spring_horizontal.mass)) * spring_horizontal.t) * ( (spring_horizontal.damping / (2 * spring_horizontal.mass)) * spring_horizontal.amplitude * Math.cos(omega * spring_horizontal.t) + omega * spring_horizontal.amplitude * Math.sin(omega * spring_horizontal.t) );
                let KE = 0.5 * spring_horizontal.mass * v * v; 
                let PE = 0.5 * spring_horizontal.k * x * x;
                let E = KE + PE;
                html = `
                    <b>Con lắc lò xo ngang:</b><br>
                    Thời gian: ${(spring_horizontal.t).toFixed(2)} s<br>
                    Độ cứng k: ${spring_horizontal.k} N/m<br>
                    Khối lượng: ${spring_horizontal.mass} kg<br>
                    Biên độ: ${spring_horizontal.amplitude.toFixed(2)} m<br>
                    Vị trí x: ${x.toFixed(2)} m<br>
                    Vận tốc: ${v.toFixed(2)} m/s<br>
                    Động năng (KE): ${KE.toFixed(3)} J<br>
                    Thế năng (PE): ${PE.toFixed(3)} J<br>
                    Năng lượng (E): ${E.toFixed(3)} J
                `;
            } else if (experiment === 'inclined_plane') {
                let rad = inclined_plane.angle * Math.PI / 180;
                let a = (inclined_plane.g * Math.sin(rad) - inclined_plane.friction * inclined_plane.g * Math.cos(rad));
                if (a < 0) a = 0;
                let h = inclined_plane.s * Math.sin(rad); // Độ cao đã đi được (tính từ dưới lên)
                let h_max = ((600 - 150) / 40) * Math.tan(rad);
                let current_h = h_max - h;
                let KE = 0.5 * inclined_plane.mass * inclined_plane.v * inclined_plane.v;
                let PE = inclined_plane.mass * inclined_plane.g * current_h;
                html = `
                    <b>Mặt phẳng nghiêng:</b><br>
                    Thời gian: ${(inclined_plane.t).toFixed(2)} s<br>
                    Góc nghiêng: ${inclined_plane.angle}°<br>
                    Khối lượng: ${inclined_plane.mass} kg<br>
                    Gia tốc: ${a.toFixed(2)} m/s²<br>
                    Vận tốc: ${inclined_plane.v.toFixed(2)} m/s<br>
                    Quãng đường: ${inclined_plane.s.toFixed(2)} m<br>
                    Động năng (KE): ${KE.toFixed(3)} J<br>
                    Thế năng (PE): ${PE.toFixed(3)} J<br>
                    Năng lượng (E): ${(KE+PE).toFixed(3)} J
                `;
            }
            document.getElementById('info').innerHTML = html;
        }
        

        // --- Hiển thị điều chỉnh thông số ---
        function showParams() {
            let html = '';
            if (experiment === 'pendulum') {
                html = ` 
                    <div class="param-item"><span class="slider-label">Góc ban đầu (°):</span><input type="range" id="angle" min="5" max="80" value="30" oninput="document.getElementById('angle_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="angle_val">30</span></div>
                    <div class="param-item"><span class="slider-label">Độ dài (m):</span><input type="range" id="length" min="0.2" max="2" step="0.01" value="1" oninput="document.getElementById('length_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="length_val">1</span></div>
                    <div class="param-item"><span class="slider-label">Lực cản:</span><input type="range" id="damping" min="0" max="0.5" step="0.01" value="0.1" oninput="document.getElementById('damping_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="damping_val">0.1</span></div>
                    <div class="param-item"><span class="slider-label">Khối lượng (kg):</span><input type="range" id="mass" min="0.05" max="2" step="0.01" value="0.2" oninput="document.getElementById('mass_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="mass_val">0.2</span></div>
                `;
            } else if (experiment === 'spring') {
                html = `
                    <div class="param-item"><span class="slider-label">Độ cứng k (N/m):</span><input type="range" id="k" min="5" max="50" step="1" value="20" oninput="document.getElementById('k_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="k_val">20</span></div>
                    <div class="param-item"><span class="slider-label">Khối lượng (kg):</span><input type="range" id="mass" min="0.1" max="2" step="0.01" value="0.5" oninput="document.getElementById('mass_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="mass_val">0.5</span></div>
                    <div class="param-item"><span class="slider-label">Biên độ (m):</span><input type="range" id="amplitude" min="0.05" max="0.5" step="0.01" value="0.2" oninput="document.getElementById('amplitude_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="amplitude_val">0.2</span></div>
                    <div class="param-item"><span class="slider-label">Lực cản:</span><input type="range" id="damping" min="0" max="1" step="0.01" value="0.2" oninput="document.getElementById('damping_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="damping_val">0.2</span></div>
                `;
            } else if (experiment === 'projectile') {
                html = `
                    <div class="param-item"><span class="slider-label">Vận tốc ném ngang (m/s):</span><input type="range" id="vx" min="2" max="20" step="0.1" value="10" oninput="document.getElementById('vx_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="vx_val">10</span></div>
                    <div class="param-item"><span class="slider-label">Độ cao ban đầu (m):</span><input type="range" id="y" min="1" max="10" step="0.1" value="4" oninput="document.getElementById('y_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="y_val">4</span></div>
                    <div class="param-item"><span class="slider-label">Lực cản:</span><input type="range" id="damping" min="0" max="0.1" step="0.001" value="0.01" oninput="document.getElementById('damping_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="damping_val">0.01</span></div>
                    <div class="param-item"><span class="slider-label">Khối lượng (kg):</span><input type="range" id="mass" min="0.05" max="1" step="0.01" value="0.1" oninput="document.getElementById('mass_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="mass_val">0.1</span></div>
                `;
            } else if (experiment === 'ideal_gas') {
                html = `
                    <div class="param-item"><span class="slider-label">Thể tích (m³):</span><input type="range" id="V" min="0.01" max="0.1" step="0.001" value="0.0224" oninput="idealGas.V=parseFloat(this.value); idealGas.P=(idealGas.n*idealGas.R*idealGas.T)/idealGas.V; document.getElementById('V_val').innerText=this.value;"><span class="slider-value" id="V_val">0.0224</span></div>
                    <div class="param-item"><span class="slider-label">Số mol (mol):</span><input type="range" id="n" min="0.5" max="5" step="0.1" value="1" oninput="document.getElementById('n_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="n_val">1</span></div>
                    <div class="param-item"><span class="slider-label">Nhiệt độ (K):</span><input type="range" id="T" min="0" max="600" step="1" value="273" oninput="document.getElementById('T_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="T_val">273</span></div>
                `;
            } else if (experiment === 'thermo') {
                html = `
                    <div class="param-item"><span class="slider-label">Khối lượng vật (kg):</span><input type="range" id="m" min="0.1" max="5" step="0.1" value="1" oninput="document.getElementById('m_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="m_val">1</span></div>
                    <div class="param-item"><span class="slider-label">Khối lượng bình (kg):</span><input type="range" id="m_container" min="0.1" max="2" step="0.1" value="0.5" oninput="document.getElementById('m_container_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="m_container_val">0.5</span></div>
                    <div class="param-item"><span class="slider-label">Nhiệt độ ban đầu (°C):</span><input type="range" id="T0" min="-50" max="50" step="1" value="25" oninput="document.getElementById('T0_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="T0_val">25</span></div>
                    <div class="param-item"><span class="slider-label">Nhiệt dung riêng bình (J/kg.K):</span><input type="range" id="c_container" min="300" max="1000" step="10" value="900" oninput="document.getElementById('c_container_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="c_container_val">900</span></div>
                `;
            } else if (experiment === 'spring_horizontal') {
                html = `
                    <div class="param-item"><span class="slider-label">Độ cứng k (N/m):</span><input type="range" id="k" min="5" max="50" step="1" value="20" oninput="document.getElementById('k_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="k_val">20</span></div>
                    <div class="param-item"><span class="slider-label">Khối lượng (kg):</span><input type="range" id="mass" min="0.1" max="2" step="0.01" value="0.5" oninput="document.getElementById('mass_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="mass_val">0.5</span></div>
                    <div class="param-item"><span class="slider-label">Biên độ (m):</span><input type="range" id="amplitude" min="0.05" max="0.5" step="0.01" value="0.2" oninput="document.getElementById('amplitude_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="amplitude_val">0.2</span></div>
                    <div class="param-item"><span class="slider-label">Lực cản:</span><input type="range" id="damping" min="0" max="1" step="0.01" value="0.2" oninput="document.getElementById('damping_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="damping_val">0.2</span></div>
                `;
            } else if (experiment === 'inclined_plane') {
                html = `
                    <div class="param-item"><span class="slider-label">Góc nghiêng (°):</span><input type="range" id="angle" min="5" max="60" value="30" oninput="document.getElementById('angle_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="angle_val">30</span></div>
                    <div class="param-item"><span class="slider-label">Hệ số ma sát:</span><input type="range" id="friction" min="0" max="0.6" step="0.01" value="0.1" oninput="document.getElementById('friction_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="friction_val">0.1</span></div>
                    <div class="param-item"><span class="slider-label">Khối lượng (kg):</span><input type="range" id="mass" min="0.1" max="5" step="0.1" value="1" oninput="document.getElementById('mass_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="mass_val">1</span></div>
                `;
            }
            document.getElementById('params').innerHTML = html;
        }

        function resetExperiment() {
            if (experiment === 'pendulum') {
                pendulum.angle = (parseFloat(document.getElementById('angle').value) || 30) * Math.PI / 180;
                pendulum.length = parseFloat(document.getElementById('length').value) || 1;
                pendulum.mass = parseFloat(document.getElementById('mass').value) || 0.2;
                pendulum.damping = parseFloat(document.getElementById('damping').value) || 0.1;
                pendulum.aVel = 0;
                pendulum.aAcc = 0;
            } else if (experiment === 'spring') {
                spring.k = parseFloat(document.getElementById('k').value) || 20;
                spring.mass = parseFloat(document.getElementById('mass').value) || 0.5;
                spring.amplitude = parseFloat(document.getElementById('amplitude').value) || 0.2;
                spring.damping = parseFloat(document.getElementById('damping').value) || 0.2;
                spring.t = 0;
            } else if (experiment === 'projectile') {
                projectile.vx = parseFloat(document.getElementById('vx').value) || 10;
                projectile.h0 = parseFloat(document.getElementById('y').value) || 4;
                projectile.mass = parseFloat(document.getElementById('mass').value) || 0.1;
                projectile.damping = parseFloat(document.getElementById('damping').value) || 0.01;
                projectile.t = 0;
                projectile.x = 60;
                projectile.y = projectile.ground - projectile.h0 * 40;
                projectile.vy = 0;
            } else if (experiment === 'ideal_gas') {
                idealGas.V = parseFloat(document.getElementById('V').value) || 0.0224;
                idealGas.n = parseFloat(document.getElementById('n').value) || 1;
                idealGas.T = parseFloat(document.getElementById('T').value) || 273;
                idealGas.P = (idealGas.n * idealGas.R * idealGas.T) / idealGas.V;
                initMolecules();
            } else if (experiment === 'thermo') {
                thermo.m = parseFloat(document.getElementById('m').value) || 1;
                thermo.m_container = parseFloat(document.getElementById('m_container').value) || 0.5;
                thermo.c_container = parseFloat(document.getElementById('c_container').value) || 900;
                thermo.T0 = parseFloat(document.getElementById('T0').value) || 25;
                thermo.T = thermo.T0;
                thermo.Q = 0;
                thermo.t = 0;
                thermo.state = thermo.T < 0 ? 'SOLID' : (thermo.T < 100 ? 'LIQUID' : 'GAS');
                if (thermo.T === 0) thermo.state = 'MELTING';
            } else if (experiment === 'spring_horizontal') {
                spring_horizontal.k = parseFloat(document.getElementById('k').value) || 20;
                spring_horizontal.mass = parseFloat(document.getElementById('mass').value) || 0.5;
                spring_horizontal.amplitude = parseFloat(document.getElementById('amplitude').value) || 0.2;
                spring_horizontal.damping = parseFloat(document.getElementById('damping').value) || 0.2;
                spring_horizontal.t = 0;
            } else if (experiment === 'inclined_plane') {
                inclined_plane.angle = parseFloat(document.getElementById('angle').value) || 30;
                inclined_plane.mass = parseFloat(document.getElementById('mass').value) || 1;
                inclined_plane.friction = parseFloat(document.getElementById('friction').value) || 0.1;
                inclined_plane.s = 0;
                inclined_plane.v = 0;
                inclined_plane.t = 0;
            }
        }

        function changeExperiment() {
            experiment = document.getElementById('experiment').value;
            setupChartForExperiment(); // Thêm dòng này để khởi tạo lại biểu đồ đúng loại
            showParams();
            resetExperiment();
            showFormula();
        }
        
        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').innerText = isPaused ? 'Tiếp tục' : 'Tạm dừng';
        }

        function speedUp() {
            speed *= 2;
            if (speed > 8) speed = 8;
        }

        function speedDown() {
            speed /= 2;
            if (speed < 0.125) speed = 0.125;
        }

        function toggleHeating() {
            thermo.heating = !thermo.heating;
            document.getElementById('heatBtn').innerText = thermo.heating ? 'Tắt lửa' : 'Bật lửa';
            if (thermo.heating) thermo.lastUpdate = Date.now();
        }

        // --- Chart Functions ---
        function initChart() {
            const chartCanvas = document.getElementById('energyChart').getContext('2d');
            energyChart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        { label: 'Động năng (KE)', data: chartData.KE, borderColor: '#4caf50', fill: false, borderWidth: 2, pointRadius: 0 },
                        { label: 'Thế năng (PE)', data: chartData.PE, borderColor: '#2196f3', fill: false, borderWidth: 2, pointRadius: 0 },
                        { label: 'Cơ năng (E)', data: chartData.E, borderColor: '#ff9800', fill: false, borderWidth: 2, pointRadius: 0, borderDash: [5, 5] }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    title: { display: true, text: 'Biểu đồ Năng lượng', fontColor: '#f1f1f1' },
                    scales: {
                        xAxes: [{ ticks: { fontColor: '#f1f1f1' }, gridLines: { color: 'rgba(255,255,255,0.1)' } }],
                        yAxes: [{ ticks: { fontColor: '#f1f1f1' }, gridLines: { color: 'rgba(255,255,255,0.1)' }, scaleLabel: { display: true, labelString: 'Năng lượng (J)', fontColor: '#f1f1f1' } }]
                    },
                    legend: { labels: { fontColor: '#f1f1f1' } }
                }
            });
        }

        function updateChartData() {
            let KE = 0, PE = 0, E = 0;
            const MAX_POINTS = 200;

            if (['pendulum', 'spring', 'spring_horizontal', 'projectile', 'inclined_plane'].includes(experiment) && energyChart.config.type === 'line') {
                const infoHtml = document.getElementById('info').innerHTML;
                const keMatch = infoHtml.match(/Động năng \(KE\): ([\d.-]+) J/);
                const peMatch = infoHtml.match(/Thế năng \(PE\): ([\d.-]+) J/);
                if (keMatch) KE = parseFloat(keMatch[1]);
                if (peMatch) PE = parseFloat(peMatch[1]);
                E = KE + PE;

                chartData.KE.push(KE);
                chartData.PE.push(PE);
                chartData.E.push(E);
                chartData.labels.push('');

                if (chartData.KE.length > MAX_POINTS) {
                    chartData.KE.shift();
                    chartData.PE.shift();
                    chartData.E.shift();
                    chartData.labels.shift();
                }
                energyChart.data.datasets[0].data = chartData.KE;
                energyChart.data.datasets[1].data = chartData.PE;
                energyChart.data.datasets[2].data = chartData.E;
                energyChart.data.labels = chartData.labels;

            } else if (experiment === 'ideal_gas' && energyChart.config.type === 'bar') {
                // ... (logic cho biểu đồ khí lý tưởng không đổi)
                const v_rms = Math.sqrt(3 * idealGas.R * idealGas.T / idealGas.M);
                const sim_v_avg = Math.sqrt(idealGas.T) * 0.1 * Math.sqrt(2 * (0.5**2)/2); // RMS của (rand-0.5)
                const scalingFactor = v_rms / (sim_v_avg * Math.sqrt(2)); // Heuristic scaling

                const speeds = idealGas.molecules.map(m => Math.sqrt(m.vx*m.vx + m.vy*m.vy) * scalingFactor);
                const bins = new Array(30).fill(0); // 30 bins, mỗi bin 50 m/s
                speeds.forEach(s => {
                    const binIndex = Math.floor(s / 50);
                    if (binIndex < bins.length) {
                        bins[binIndex]++;
                    }
                });
                // Chuẩn hóa histogram
                const totalMolecules = idealGas.molecules.length;
                const normalizedBins = bins.map(count => count / totalMolecules);

                // Lấy đường cong lý thuyết
                const { velocities, probabilities } = getMaxwellBoltzmannDistribution(idealGas.T, idealGas.M);
                
                energyChart.data.datasets[0].data = normalizedBins; // Histogram
                energyChart.data.datasets[1].data = probabilities; // Lý thuyết
                energyChart.data.labels = velocities.map(v => v);
            } else if (experiment === 'thermo' && energyChart.config.type === 'line') {
                chartData.T.push(thermo.T);
                chartData.labels.push(thermo.t.toFixed(1));

                if (chartData.T.length > MAX_POINTS) {
                    chartData.T.shift();
                    chartData.labels.shift();
                }
                energyChart.data.datasets[0].data = chartData.T;
                energyChart.data.labels = chartData.labels;
            }
            
            energyChart.update({ duration: 0 });
        }

        function setupChartForExperiment() {
            if (energyChart) energyChart.destroy();
            const chartCanvas = document.getElementById('energyChart').getContext('2d');

            if (experiment === 'ideal_gas') {
                chartData = {}; // Dữ liệu cho biểu đồ này được tạo riêng
                initMaxwellChart(chartCanvas);
            } else if (experiment === 'thermo') {
                chartData = { T: [], labels: [] }; // Dữ liệu nhiệt độ
                initTemperatureChart(chartCanvas);
            } else {
                chartData = { KE: [], PE: [], E: [], labels: [] }; // Dữ liệu năng lượng
                initEnergyChart(chartCanvas);
            }
        }

        function initEnergyChart(canvas) {
            initChart(); // Tên hàm cũ, giờ chỉ dùng cho năng lượng
        }
        function initMaxwellChart(canvas) {
            energyChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: [], // Vận tốc (m/s)
                    datasets: [
                        {
                            label: 'Phân bố thực tế (Mô phỏng)',
                            data: [],
                            backgroundColor: 'rgba(230, 126, 34, 0.6)',
                            borderColor: '#e67e22',
                            borderWidth: 1
                        },
                        {
                            label: 'Phân bố lý thuyết (Maxwell-Boltzmann)',
                            data: [],
                            type: 'line',
                            borderColor: '#ffd54f',
                            fill: false,
                            borderWidth: 2,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: { duration: 0 },
                    title: { display: true, text: 'Phân bố vận tốc phân tử', fontColor: '#f1f1f1' },
                    scales: {
                        xAxes: [{ scaleLabel: { display: true, labelString: 'Vận tốc (m/s)', fontColor: '#f1f1f1' }, ticks: { fontColor: '#f1f1f1' }, gridLines: { color: 'rgba(255,255,255,0.1)' } }],
                        yAxes: [{ scaleLabel: { display: true, labelString: 'Xác suất', fontColor: '#f1f1f1' }, ticks: { fontColor: '#f1f1f1', beginAtZero: true }, gridLines: { color: 'rgba(255,255,255,0.1)' } }]
                    },
                    legend: { labels: { fontColor: '#f1f1f1' } }
                }
            });
        }

        function initTemperatureChart(canvas) {
            energyChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Nhiệt độ (°C)',
                        data: chartData.T,
                        borderColor: '#ff6384',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: { duration: 0 },
                    title: { display: true, text: 'Biểu đồ Nhiệt độ', fontColor: '#f1f1f1' },
                    scales: {
                        xAxes: [{ scaleLabel: { display: true, labelString: 'Thời gian (s)', fontColor: '#f1f1f1' }, ticks: { fontColor: '#f1f1f1' }, gridLines: { color: 'rgba(255,255,255,0.1)' } }],
                        yAxes: [{ scaleLabel: { display: true, labelString: 'Nhiệt độ (°C)', fontColor: '#f1f1f1' }, ticks: { fontColor: '#f1f1f1' }, gridLines: { color: 'rgba(255,255,255,0.1)' } }]
                    },
                    legend: { labels: { fontColor: '#f1f1f1' } }
                }
            });
        }

        function animate() {
            if (!isPaused) {
                let updateCount = Math.max(1, Math.floor(speed));
                for (let i = 0; i < updateCount; i++) {
                    if (experiment === 'pendulum') updatePendulum();
                    else if (experiment === 'spring') updateSpring();
                    else if (experiment === 'projectile') updateProjectile();
                    else if (experiment === 'ideal_gas') updateIdealGas();
                    else if (experiment === 'thermo') updateThermo();
                    else if (experiment === 'spring_horizontal') updateSpringHorizontal();
                    else if (experiment === 'inclined_plane') updateInclinedPlane();
                }
            }
            if (experiment === 'pendulum') drawPendulum();
            else if (experiment === 'spring') drawSpring();
            else if (experiment === 'projectile') drawProjectile();
            else if (experiment === 'ideal_gas') drawIdealGas();
            else if (experiment === 'thermo') drawThermo();
            else if (experiment === 'spring_horizontal') drawSpringHorizontal();
            else if (experiment === 'inclined_plane') drawInclinedPlane();
            showInfo();
            if (!isPaused) {
                updateChartData();
            }
            requestAnimationFrame(animate);
        }

        // --- Khởi chạy ---
        changeExperiment(); // Hàm này giờ đã bao gồm cả việc setup biểu đồ
        animate();
    </script>
</body>
</html>
Một số tính năng còn chưa hoàn thiện! Mình sẽ tiếp tục cập nhật trong thời gian tới.
