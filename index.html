<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Phòng Thí Nghiệm Vật Lí Ảo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #0a0f14, #161b22);
      --accent-color: #00f7ff; /* Cyber Cyan */
      --accent-color-dark: #f700ff; /* Magenta Glow */
      --accent-glow: rgba(0, 247, 255, 0.25);
      --accent-glow-dark: rgba(247, 0, 255, 0.2);
      --card-bg: rgba(18, 24, 33, 0.5);
      --text-color: #f1f1f1;
      --text-color-bright: #ffffff;
      --text-color-muted: #a0a8b3;
      --border-color: rgba(139, 148, 158, 0.25);
      --shadow-color: rgba(0,0,0,0.4);
      --control-bg: rgba(13, 17, 23, 0.6);
      --slider-track: #4a4a52;
      --border-radius-main: 16px;
    }

    body {
      position: relative;
      background: var(--bg-gradient);
      color: var(--text-color);
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    h2 {
      text-align: center;
      margin: 0 0 20px 0;
      color: var(--accent-color);
      text-shadow: 0 0 8px var(--accent-glow), 0 0 16px var(--accent-glow-dark);
      font-weight: 600;
      animation: text-glow 2s ease-in-out infinite alternate;
    }
    /* Aurora background effect */
    body::before {
        content: '';
        position: fixed;
        top: 0; left: 0;
        width: 200%; height: 200%;
        background: radial-gradient(circle at 10% 20%, var(--accent-glow), transparent 40%),
                    radial-gradient(circle at 90% 80%, var(--accent-glow-dark), transparent 40%);
        z-index: -2;
        animation: aurora-move 20s linear infinite;
    }
    /* Scanline effect */
    body::after {
        content: '';
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: repeating-linear-gradient(0deg, rgba(0,0,0,0) 0px, rgba(0,0,0,0) 1px, rgba(0,0,0,0.1) 2px);
        pointer-events: none;
        z-index: -1;
    }
    @keyframes text-glow {
        from { text-shadow: 0 0 8px var(--accent-glow); }
        to { text-shadow: 0 0 16px var(--accent-glow), 0 0 24px var(--accent-glow-dark); }
    }
    @keyframes aurora-move {
        0% { transform: translate(0, 0); }
        50% { transform: translate(-25%, -25%); }
        100% { transform: translate(0, 0); }
    }

    /* Theme classes */
    body.theme-deep-space { --bg-gradient: linear-gradient(135deg, #1D2B64, #000000); }
    body.theme-nebula { --bg-gradient: linear-gradient(135deg, #23074d, #cc5333); }
    body.theme-sunset { --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364); }
    body.theme-default { --bg-gradient: linear-gradient(135deg, #1a1a2e, #2c2c3e); }

    .main-layout {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 320px;
      flex-shrink: 0;
      background: rgba(13, 17, 23, 0.6);
      border-right: 1px solid var(--border-color);
      padding: 25px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      transition: transform 0.3s ease;
      backdrop-filter: blur(12px);
    }

    .main-content {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius-main);
      padding: 20px;
      border: 1px solid transparent;
      background-clip: padding-box;
      position: relative;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      backdrop-filter: blur(12px) saturate(120%);
      transition: all 0.3s ease;
      animation: card-fade-in 0.5s ease-out forwards;
      opacity: 0;
    }
    .card:hover {
      box-shadow: 0 0 25px var(--accent-glow), 0 0 40px var(--accent-glow-dark);
      transform: translateY(-2px);
    }
    .card::before {
      content: '';
      position: absolute; inset: 0; border-radius: var(--border-radius-main);
      padding: 1px; /* border width */
      background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
    @keyframes card-fade-in {
      to { opacity: 1; transform: translateY(0); }
    }
    canvas {
      background: #10141a; /* A slightly different shade for contrast */
      border-radius: 10px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
      width: 100%;
      height: auto;
      border: 1px solid var(--border-color);
      transition: box-shadow 0.3s ease;
    }
    .canvas-wrapper.card:hover canvas {
        box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 0 15px var(--accent-glow);
    }
    #params {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 18px 20px;
    }
    .param-item {
      display: flex;
      align-items: center;
      width: 100%;
    }
    .select-wrapper {
      position: relative;
      width: 100%;
    }
    .select-wrapper::after {
      content: '▼';
      position: absolute;
      top: 50%;
      right: 12px;
      transform: translateY(-50%);
      font-size: 0.8em;
      color: var(--text-color-muted);
      pointer-events: none;
    }
    select {
      -webkit-appearance: none;
      appearance: none;
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      background: var(--control-bg);
      color: var(--text-color);
      font-family: 'Poppins', sans-serif;
      width: 100%;
      padding-right: 30px; /* Space for arrow */
      cursor: pointer;
    }
    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 5px;
      padding: 10px 18px;
      border-radius: 4px;
      border: 1px solid var(--accent-color);
      background: linear-gradient(45deg, transparent 50%, var(--accent-color) 50%);
      background-size: 220%;
      background-position: 0%;
      color: #fff;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      cursor: pointer; 
      transition: all 0.4s ease-in-out;
      gap: 8px;
      box-shadow: 0 0 10px var(--accent-glow);
      position: relative;
      overflow: hidden;
    }
    button:hover {
      background-position: 100%;
      color: #000;
      box-shadow: 0 0 25px var(--accent-glow);
    }
    button:active {
      transform: translateY(0);
      filter: brightness(0.9);
    }
    button::before {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
      transition: left 0.5s;
    }
    button:hover::before {
      left: 100%;
    }
    button:focus-visible {
      outline: 2px solid var(--accent-color);
      outline-offset: 2px;
    }
    input[type="range"] {
      -webkit-appearance: none;
      width: 120px;
      height: 8px;
      background: #2a2f3b;
      border-radius: 5px;
      outline: none;
      margin: 0 10px;
      background-image: linear-gradient(var(--accent-color), var(--accent-color));
      background-size: 0% 100%;
      background-repeat: no-repeat;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent-color);
      cursor: pointer;
      border-radius: 50%;
      border: 2px solid var(--control-bg);
      box-shadow: 0 0 12px var(--accent-glow);
      transition: background-color .2s, transform .2s, box-shadow .2s;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 0 25px var(--accent-glow);
    }
    input[type="range"]::-moz-range-thumb { /* Firefox */
        width: 18px; height: 18px; background: var(--accent-color); cursor: pointer; border-radius: 50%; border: none;
    }
    input[type="range"]::-moz-range-track { /* Firefox */
        height: 8px; background: var(--slider-track); border-radius: 5px;
    }
    .formula {
      margin: 15px 0;
      color: var(--text-color-bright);
    }
    #info {
      margin-top: 15px;
      font-size: 1em;
      text-align: left;
      line-height: 1.5;
    }
    .slider-label {
      width: 140px;
      text-align: right;
      font-size: 0.85em;
      color: var(--text-color);
      margin-right: 10px;
    }
    .slider-value {
      min-width: 40px; text-align: left;
    }
    .simulation-area {
      display: flex;
      flex-direction: column;
      gap: 20px;
      height: 100%;
    }
    .canvas-wrapper {
      flex-grow: 1;
      position: relative;
    }
    .chart-container {
      flex-grow: 1; min-width: 200px; padding: 10px;
    }

    /* Theme switcher */
    .theme-switcher {
        position: relative;
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-top: 10px;
        background: rgba(0,0,0,0.2);
        padding: 6px;
        border-radius: 8px;
    }
    .theme-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: transform 0.2s, border-color 0.2s;
    }
    .theme-dot:hover {
        transform: scale(1.1);
    }
    .theme-dot.active {
        border-color: var(--accent-color);
        transform: scale(1.2);
    }
    .theme-dot:not(.active):hover {
        border-color: rgba(255,255,255,0.5);
    }
    #theme-default { background: linear-gradient(45deg, #1a1a2e, #2c2c3e); }
    #theme-deep-space { background: linear-gradient(45deg, #1D2B64, #000000); }
    #theme-nebula { background: linear-gradient(45deg, #23074d, #cc5333); }
    #theme-sunset { background: linear-gradient(45deg, #0f2027, #2c5364); }

    .card-header {
      font-weight: 600;
      color: var(--accent-color);
      margin-bottom: 10px;
      border-bottom: 1px solid var(--accent-color);
      padding-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      text-shadow: 0 0 5px var(--accent-glow);
    }
    .card-header .icon {
      opacity: 0.8;
    }

    .speed-indicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .sidebar-toggle {
      display: none; /* Hidden by default, shown on mobile */
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1001;
      width: 40px;
      height: 40px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-color);
      backdrop-filter: blur(5px);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          left: 0; top: 0; bottom: 0;
          z-index: 1000;
          transform: translateX(-100%);
        }
        .sidebar.open {
          transform: translateX(0);
        }
        .main-content {
          padding: 15px;
        }
        .sidebar-toggle {
          display: flex;
        }
    }
    .icon { width: 1em; height: 1em; fill: currentColor; }
    .sidebar-toggle .icon { transition: transform 0.3s ease; }
    .sidebar.open + .main-content .sidebar-toggle .icon { transform: rotate(90deg); }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--accent-color);
      border-radius: 4px;
    }

  </style>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <button class="sidebar-toggle" id="sidebarToggle" title="Mở/Đóng menu"><svg class="icon" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>
  <div class="main-layout">
    <aside class="sidebar" id="sidebar">
      <h2>Phòng Thí Nghiệm Vật Lí Ảo</h2>
      <div class="card" style="animation-delay: 0.1s;">
        <div class="card-header"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>Điều khiển chính</div>
        <div style="text-align: center;">
          <button onclick="resetExperiment()" title="Khởi động lại"><svg class="icon" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></button>
          <button onclick="togglePause()" id="pauseBtn" title="Tạm dừng/Tiếp tục"><svg class="icon" id="pauseIcon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg><svg class="icon" id="playIcon" viewBox="0 0 24 24" style="display:none;"><path d="M8 5v14l11-7z"/></svg></button>
          <button onclick="speedDown()" title="Tua chậm"><svg class="icon" viewBox="0 0 24 24"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6 8.5 6V6l-8.5 6z"/></svg></button>
          <button onclick="speedUp()" title="Tua nhanh"><svg class="icon" viewBox="0 0 24 24"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg></button>
          <button onclick="toggleHeating()" id="heatBtn" title="Bật/Tắt lửa" style="display: none;"><svg class="icon" viewBox="0 0 24 24"><path d="M13.04,1.41l-2.1,2.1c-0.12,0.12-0.18,0.28-0.18,0.44v1.2c0,0.41,0.34,0.75,0.75,0.75s0.75-0.34,0.75-0.75v-0.69l1.3,1.3 c1.9,1.9,1.9,5,0,6.9c-1.9,1.9-5,1.9-6.9,0c-1.9-1.9-1.9-5,0-6.9l1.3-1.3V5.75C8.66,5.34,8.32,5,7.91,5s-0.75,0.34-0.75,0.75v1.2 c0,0.16-0.06,0.32-0.18,0.44l-2.1,2.1C3.01,11.36,2,13.85,2,16.5C2,20.09,4.91,23,8.5,23s6.5-2.91,6.5-6.5 C15,13.85,14.79,11.36,13.04,1.41z M8.5,21C6.02,21,4,18.98,4,16.5c0-1.74,0.71-3.33,1.88-4.5l1.41-1.41c0.12-0.12,0.18-0.28,0.18-0.44 V8.75c0-0.41,0.34-0.75,0.75-0.75s0.75,0.34,0.75,0.75v1.41c0,0.16,0.06,0.32,0.18,0.44l1.41,1.41C12.29,13.17,13,14.76,13,16.5 C13,18.98,10.98,21,8.5,21z"/></svg></button>
        </div>
      </div>

      <div class="card" style="animation-delay: 0.2s;">
        <div class="card-header"><svg class="icon" viewBox="0 0 24 24"><path d="M19.48 12.04c-1.34-.78-2.2-2.2-2.2-3.79V2h-2.5v6.25c0 1.59-.86 3.01-2.2 3.79-1.34.78-2.2 2.2-2.2 3.79V22h2.5v-6.25c0-1.59.86-3.01 2.2-3.79 1.34-.78 2.2-2.2 2.2-3.79V2h2.5v6.25c0 1.59.86 3.01 2.2 3.79 1.34.78 2.2 2.2 2.2 3.79V22h-2.5v-6.21c0-1.59-.86-3.01-2.2-3.75z"/></svg>Thí nghiệm</div>
        <div class="select-wrapper">
            <select id="experiment" onchange="changeExperiment()">
                <option value="pendulum">Con lắc đơn</option>
                <option value="spring">Lò xo</option>
                <option value="projectile">Chuyển động ném ngang</option>
                <option value="ideal_gas">Khí lý tưởng</option>
                <option value="thermo">Nhiệt động lực học</option>
                <option value="spring_horizontal">Con lắc lò xo ngang</option>
                <option value="inclined_plane">Mặt phẳng nghiêng</option>
            </select>
        </div>
        <div class="formula" id="formula"></div>
      </div>

      <div class="card" style="animation-delay: 0.3s;">
        <div class="card-header"><svg class="icon" viewBox="0 0 24 24"><path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/></svg>Thông số</div>
        <div id="params"></div>
      </div>

      <div class="card" id="info" style="animation-delay: 0.4s;"></div>

      <div class="card" style="animation-delay: 0.5s;">
        <div class="card-header"><svg class="icon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 11s-.67 1.5-1.5 1.5zm3-4c-.83 0-1.5-.67-1.5-1.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>Giao diện</div>
        <div class="theme-switcher">
          <div class="theme-dot" id="theme-default" title="Mặc định" onclick="changeTheme('theme-default')"></div>
          <div class="theme-dot" id="theme-deep-space" title="Không gian sâu" onclick="changeTheme('theme-deep-space')"></div>
          <div class="theme-dot" id="theme-nebula" title="Tinh vân" onclick="changeTheme('theme-nebula')"></div>
          <div class="theme-dot" id="theme-sunset" title="Hoàng hôn" onclick="changeTheme('theme-sunset')"></div>
        </div>
      </div>
      <div style="margin-top: auto; text-align: center; font-size: 0.8em; color: var(--text-color-muted);">Ver 1.0 - By Developer Anh Viet</div>
    </aside>

    <main class="main-content">
      <div class="simulation-area">
          <div class="canvas-wrapper card">
            <canvas id="canvas" width="700" height="450"></canvas>
            <div id="speedIndicator" class="speed-indicator">x1</div>
          </div>
          <div class="chart-container card">
              <canvas id="energyChart"></canvas>
          </div>
      </div>
    </main>
  </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let experiment = 'pendulum';
        let isPaused = false;
        let speed = 1;
        let energyChart;
        let chartData = { KE: [], PE: [], E: [], labels: [] };
        const timeStep = 0.016; // ~60 FPS

        // --- Con lắc đơn ---
        let pendulum = {
            length: 1, // mét
            angle: Math.PI / 6, // rad
            damping: 0.1, // Hệ số cản
            aVel: 0, aAcc: 0,
            gravity: 9.81, // m/s^2
            origin: { x: 350, y: 60 },
            mass: 0.2 // kg
        };

        // --- Lò xo ---
        let spring = {
            k: 20, // N/m
            mass: 0.5, // kg
            amplitude: 0.2, // mét
            damping: 0.2, // Hệ số cản
            t: 0 // thời gian mô phỏng
        };

        // --- Ném ngang ---
        let projectile = {
            x: 60, y: 60,
            vx: 10, // m/s
            damping: 0.01, // Hệ số cản
            vy: 0,
            g: 9.81, // m/s^2
            radius: 15,
            ground: 430, // pixel
            t: 0, // thời gian mô phỏng
            h0: 4, // mét
            mass: 0.1 // kg
        };

        // --- Khí lý tưởng ---
        let idealGas = {
            P: 101325, // Pa
            V: 0.0224, // m³
            n: 1, // mol
            T: 273, // K
            R: 8.314, // J/mol.K
            box: { x: 230, y: 100, w: 240, h: 200 },
            M: 0.028, // kg/mol (Khí N2)
            molecules: []
        };

        // --- Nhiệt động lực học ---
        let thermo = {
            Q: 0, // J
            m: 1, // kg
            c: 4200, // J/kg.K
            c_water: 4200, // Nhiệt dung riêng của nước
            c_ice: 2100,   // Nhiệt dung riêng của đá
            Lf: 334000,  // Ẩn nhiệt nóng chảy (J/kg)
            Lv: 2260000, // Ẩn nhiệt hóa hơi (J/kg)
            T0: 25, // °C
            T: 25, // °C
            heating: false,
            state: 'LIQUID', // SOLID, LIQUID, GAS, MELTING, BOILING
            lastUpdate: 0,
            m_container: 0.5, // kg
            c_container: 900,  // J/kg.K (Nhôm)
            t: 0 // Thời gian mô phỏng
        };

        // --- Con lắc lò xo ngang ---
        let spring_horizontal = {
            k: 20, // N/m
            mass: 0.5, // kg
            amplitude: 0.2, // m
            damping: 0.2, // Hệ số cản
            x0: 350, // px
            t: 0 // thời gian mô phỏng
        };

        // --- Mặt phẳng nghiêng ---
        let inclined_plane = {
            angle: 30, // độ
            mass: 1, // kg
            g: 9.81,
            friction: 0.1, // Hệ số ma sát
            F_pull: 0, // Lực kéo (N)
            s: 0, // Quãng đường đi được (m) - s > 0 là đi lên, s < 0 là đi xuống
            v: 0, t: 0 // Vận tốc (m/s), thời gian (s)
        };

        // --- Khởi tạo phân tử khí ---
        function initMolecules() {
            idealGas.molecules = [];
            let count = Math.min(Math.round(idealGas.n * 50), 100);
            for (let i = 0; i < count; i++) {
                idealGas.molecules.push({
                    x: idealGas.box.x + 10 + Math.random() * (idealGas.box.w - 20),
                    y: idealGas.box.y + 10 + Math.random() * (idealGas.box.h - 20),
                    vx: (idealGas.T > 0 ? (Math.random() - 0.5) * Math.sqrt(idealGas.T) * 0.1 : 0),
                    vy: (idealGas.T > 0 ? (Math.random() - 0.5) * Math.sqrt(idealGas.T) * 0.1 : 0)
                });
            }
        }

        // --- Vẽ con lắc đơn ---
        function drawPendulum() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let pxLength = pendulum.length * 150; // chuyển mét sang px
            let x = pendulum.origin.x + pxLength * Math.sin(pendulum.angle);
            let y = pendulum.origin.y + pxLength * Math.cos(pendulum.angle);
            ctx.beginPath();
            ctx.moveTo(pendulum.origin.x, pendulum.origin.y);
            ctx.lineTo(x, y);
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, 2 * Math.PI);
            ctx.fillStyle = "#ffb300";
            ctx.shadowColor = "#ffb300";
            ctx.shadowBlur = 15;
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.beginPath();
            ctx.arc(pendulum.origin.x, pendulum.origin.y, 8, 0, 2 * Math.PI);
            ctx.fillStyle = "#fff";
            ctx.fill();
        }

        function updatePendulum() {
            pendulum.aAcc = (-pendulum.gravity / pendulum.length) * Math.sin(pendulum.angle);
            let dampingForce = -pendulum.damping * pendulum.aVel;
            pendulum.aVel += (pendulum.aAcc + dampingForce) * timeStep;
            pendulum.angle += pendulum.aVel * timeStep;
        }

        // --- Vẽ lò xo ---
        function drawSpring() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let omega = Math.sqrt(spring.k / spring.mass);
            // Thêm hệ số tắt dần vào biên độ
            let current_amplitude = spring.amplitude * Math.exp(-(spring.damping / (2 * spring.mass)) * spring.t);
            let y = 200 + current_amplitude * Math.cos(omega * spring.t) * 300;
            ctx.beginPath();
            ctx.moveTo(350, 50);
            ctx.lineTo(350, y - 20);
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 6;
            ctx.stroke();
            ctx.beginPath();
            ctx.rect(320, y - 20, 60, 40);
            ctx.fillStyle = "#ffb300";
            ctx.shadowColor = "#ffb300";
            ctx.shadowBlur = 15;
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.beginPath();
            ctx.arc(350, 50, 8, 0, 2 * Math.PI);
            ctx.fillStyle = "#fff";
            ctx.fill();
        }

        function updateSpring() {
            spring.t += timeStep;
        }

        // --- Vẽ con lắc lò xo ngang ---
        function drawSpringHorizontal() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let omega = Math.sqrt(spring_horizontal.k / spring_horizontal.mass);
            // Thêm hệ số tắt dần vào biên độ
            let current_amplitude = spring_horizontal.amplitude * Math.exp(-(spring_horizontal.damping / (2 * spring_horizontal.mass)) * spring_horizontal.t);
            let x = spring_horizontal.x0 + current_amplitude * Math.cos(omega * spring_horizontal.t) * 300;
            ctx.beginPath();
            ctx.moveTo(150, 225);
            ctx.lineTo(x, 225);
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 6;
            ctx.stroke();
            ctx.beginPath();
            ctx.rect(x, 205, 40, 40);
            ctx.fillStyle = "#ffb300";
            ctx.fill();
        }

        function updateSpringHorizontal() {
            spring_horizontal.t += timeStep;
        }

        // --- Vẽ ném ngang ---
        function drawProjectile() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.moveTo(0, projectile.ground);
            ctx.lineTo(canvas.width, projectile.ground);
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(projectile.x, projectile.y, projectile.radius, 0, 2 * Math.PI);
            ctx.fillStyle = "#ffb300";
            ctx.shadowColor = "#ffb300";
            ctx.shadowBlur = 15;
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function updateProjectile() {
            const scale = 40; // 40px = 1m
            if (projectile.y + projectile.radius < projectile.ground) {
                projectile.t += timeStep * speed;
                // Cập nhật vận tốc với lực cản
                projectile.vy += projectile.g * timeStep * speed;
                projectile.vx -= projectile.damping * projectile.vx * timeStep * speed;
                projectile.vy -= projectile.damping * projectile.vy * timeStep * speed;
                // Cập nhật vị trí
                projectile.x += projectile.vx * timeStep * speed * scale;
                projectile.y += projectile.vy * timeStep * speed * scale;
            } else {
                // Đảm bảo vật dừng chính xác trên mặt đất, không bị lún xuống
                projectile.y = projectile.ground - projectile.radius;
            }
        }

        // --- Khí lý tưởng ---
        function drawIdealGas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 3;
            ctx.strokeRect(idealGas.box.x, idealGas.box.y, idealGas.box.w, idealGas.box.h);
            // Vẽ piston. 0.1 là giá trị max của slider V, tương ứng với chiều cao tối đa của hộp.
            let maxVolumeDisplay = 0.1; 
            let pistonY = idealGas.box.y + idealGas.box.h - (idealGas.V / 0.1 * idealGas.box.h);
            ctx.fillStyle = "#aaa";
            ctx.fillRect(idealGas.box.x, pistonY, idealGas.box.w, 10);
            
            idealGas.molecules.forEach(mol => {
                ctx.beginPath();
                ctx.arc(mol.x, mol.y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = idealGas.T > 0 ? "#ffb300" : "#888";
                ctx.fill();
            });
        }

        function updateIdealGas() {
            if (isPaused) return;
            let maxVolumeDisplay = 0.1;
            let pistonY = idealGas.box.y + idealGas.box.h - (idealGas.V / maxVolumeDisplay * idealGas.box.h);
            if (idealGas.T <= 0) { // Dừng chuyển động và cho rơi xuống đáy khi T=0K
                idealGas.molecules.forEach(mol => {
                    const bottomY = idealGas.box.y + idealGas.box.h - 5;
                    if (mol.y < bottomY) {
                        mol.y += 1; // Mô phỏng trọng lực
                        if (mol.y > bottomY) mol.y = bottomY; // Đảm bảo không lún qua đáy
                    }
                    mol.vx = 0; mol.vy = 0;
                });
                return;
            }

            idealGas.molecules.forEach(mol => {
                mol.x += mol.vx * speed;
                mol.y += mol.vy * speed;
                // Va chạm với tường trái/phải
                if (mol.x < idealGas.box.x + 5) {
                    mol.x = idealGas.box.x + 5; // Ngăn không cho dính vào tường
                    mol.vx *= -1;
                } else if (mol.x > idealGas.box.x + idealGas.box.w - 5) {
                    mol.x = idealGas.box.x + idealGas.box.w - 5; // Ngăn không cho dính vào tường
                    mol.vx *= -1;
                }
                // Va chạm với tường trên
                if (mol.y < idealGas.box.y + 5) {
                    mol.y = idealGas.box.y + 5; // Ngăn không cho dính vào tường
                    mol.vy *= -1;
                }
                // Va chạm với piston (ranh giới dưới của khí)
                if (mol.y > pistonY - 5) { // Nếu tâm phân tử vượt quá bề mặt piston (trừ bán kính)
                    mol.y = pistonY - 5; // Đặt lại vị trí ngay trên bề mặt piston
                    mol.vy *= -1;
                }

            });
        }

        // --- Vẽ nhiệt động lực học ---
        function drawThermo() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Vẽ bình chứa
            ctx.save();
            ctx.beginPath();
            ctx.arc(350, 250, 70, Math.PI, 2 * Math.PI);
            ctx.lineTo(420, 350);
            ctx.arc(350, 350, 70, 0, Math.PI);
            ctx.arc(350, 350, 70, 0, Math.PI); // Đáy bình
            ctx.lineTo(280, 250);
            ctx.arc(350, 250, 70, Math.PI, 2*Math.PI); // Miệng bình
            ctx.closePath();
            ctx.fillStyle = "#2196f3";
            ctx.fill();
            ctx.clip(); // Giới hạn vùng vẽ bên trong bình

            // Vẽ trạng thái vật chất
            if (thermo.state === 'SOLID' || thermo.state === 'MELTING') {
                ctx.fillStyle = "rgba(173, 216, 230, 0.8)"; // Màu đá
                ctx.fillRect(280, 250, 140, 100);
                // Vẽ các đường nứt cho đá
                ctx.strokeStyle = "rgba(255, 255, 255, 0.4)";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(300, 280); ctx.lineTo(380, 320);
                ctx.moveTo(360, 260); ctx.lineTo(320, 340);
                ctx.stroke();
            }
            if (thermo.state === 'LIQUID' || thermo.state === 'MELTING' || thermo.state === 'BOILING') {
                ctx.fillStyle = "#2196f3"; // Màu nước
                ctx.fillRect(280, 250, 140, 100);
            }
            ctx.restore(); // Bỏ giới hạn clip

            // Vẽ lại đường viền bình
            ctx.beginPath();
            ctx.arc(350, 350, 70, 0, Math.PI); ctx.lineTo(280, 250);
            ctx.arc(350, 250, 70, Math.PI, 2*Math.PI); ctx.closePath();
            ctx.strokeStyle = "#ccc"; ctx.lineWidth = 2; ctx.stroke();

            // Vẽ nhiệt kế
            ctx.fillStyle = "#fff";
            ctx.fillRect(520, 170, 12, 120);
            ctx.fillRect(520, 150, 12, 160); // Thân nhiệt kế dài hơn
            ctx.beginPath();
            ctx.arc(526, 290, 16, 0, 2 * Math.PI);
            ctx.arc(526, 310, 16, 0, 2 * Math.PI); // Bầu nhiệt kế
            ctx.fill();

            // Cột thủy ngân, map từ -50°C đến 150°C
            let tempH = Math.max(0, Math.min((thermo.T + 50) / 200 * 160, 160));
            ctx.fillStyle = "#ff4e50";
            ctx.fillRect(522, 310 - tempH, 8, tempH);

            // Hiệu ứng
            if (thermo.heating) {
                ctx.beginPath();
                ctx.arc(350, 370, 20, 0, Math.PI, true);
                ctx.fillStyle = "#ffb300";
                ctx.fill();
            }
            if (thermo.T >= 100) {
                for (let i = 0; i < 10; i++) {
                    let bx = 310 + Math.random() * 80;
                    let by = 250 + Math.random() * 80; // Bong bóng trong vùng nước
                    ctx.beginPath();
                    ctx.arc(bx, by, 4, 0, 2 * Math.PI);
                    ctx.fillStyle = "rgba(255,255,255,0.7)";
                    ctx.fill();
                }
            }
        }

        function updateThermo() {
            let now = Date.now();
            let dt = (now - (thermo.lastUpdate || now)) / 1000;
            thermo.lastUpdate = now;
            thermo.t += dt * speed;

            let energyChange = 0;
            if (thermo.heating) {
                energyChange = 500 * dt * speed; // 500W, ảnh hưởng bởi speed
            } else {
                // Tỏa nhiệt ra môi trường (Newton's law of cooling)
                energyChange = -thermo.m * 40 * (thermo.T - 20) * dt * speed; // 20 là nhiệt độ môi trường
            }
            thermo.Q += energyChange;

            // Xử lý các trạng thái
            switch(thermo.state) {
                case 'SOLID': {
                    const totalHeatCapacity = (thermo.m * thermo.c_ice) + (thermo.m_container * thermo.c_container);
                    thermo.T += energyChange / totalHeatCapacity;
                    if (thermo.T >= 0) { thermo.T = 0; thermo.state = 'MELTING'; }
                    break;
                }
                case 'MELTING': {
                    // Nhiệt độ không đổi, chỉ có nhiệt lượng thay đổi
                    if (thermo.Q > thermo.m * thermo.Lf) {
                        thermo.Q = thermo.Q - thermo.m * thermo.Lf;
                        thermo.state = 'LIQUID';
                    } else if (thermo.Q < 0) {
                        thermo.Q = 0;
                        thermo.state = 'SOLID';
                    }
                    break;
                }
                case 'LIQUID': {
                    const totalHeatCapacity = (thermo.m * thermo.c_water) + (thermo.m_container * thermo.c_container);
                    thermo.T += energyChange / totalHeatCapacity;
                    if (thermo.T >= 100) {
                        thermo.Q = (thermo.T - 100) * thermo.m * thermo.c_water;
                        thermo.T = 100;
                        thermo.state = 'BOILING';
                    } else if (thermo.T < 0) {
                        thermo.Q = thermo.T * thermo.m * thermo.c_water;
                        thermo.T = 0;
                        thermo.state = 'MELTING';
                    }
                    break;
                }
                case 'BOILING': {
                     if (thermo.Q > thermo.m * thermo.Lv) {
                        thermo.state = 'GAS'; // Toàn bộ đã hóa hơi
                    } else if (thermo.Q < 0) {
                        thermo.Q = 0;
                        thermo.state = 'LIQUID';
                    }
                    break;
                }
                case 'GAS':
                    // Có thể thêm logic cho hơi nước siêu nhiệt ở đây
                    break;
            }
        }

        // --- Vẽ mặt phẳng nghiêng ---
        function drawInclinedPlane() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let rad = inclined_plane.angle * Math.PI / 180;
            const scale = 40; // 40px = 1m
            // Vẽ mặt phẳng nghiêng
            const startX = 150, startY = 400;
            const endX = 600;
            const endY = startY - Math.tan(rad) * (endX - startX);
            const planeLengthPx = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 8;
            ctx.stroke();

            // Vật nặng
            let current_s_px = inclined_plane.s * scale;
            let current_x = startX + current_s_px * Math.cos(rad);
            let current_y = startY - current_s_px * Math.sin(rad);

            ctx.save();
            ctx.translate(current_x, current_y);
            ctx.rotate(-rad);
            ctx.fillStyle = "#fff874";
            ctx.fillRect(-20, -20, 40, 40);
            ctx.restore();
        }
        function updateInclinedPlane() {
            const planeLengthM = (600 - 150) / 40 / Math.cos(inclined_plane.angle * Math.PI / 180);
            const rad = inclined_plane.angle * Math.PI / 180;
            const m = inclined_plane.mass;
            const g = inclined_plane.g;
            const mu = inclined_plane.friction;
            const F_pull = inclined_plane.F_pull;

            // Các lực tác động (chiếu lên phương song song với mặt phẳng nghiêng)
            const F_gravity_parallel = m * g * Math.sin(rad);
            const F_friction_max = mu * m * g * Math.cos(rad);
            let a = 0;

            if (inclined_plane.v === 0) {
                // Vật đang đứng yên, kiểm tra điều kiện để bắt đầu chuyển động
                const F_parallel_net = F_pull - F_gravity_parallel;
                if (Math.abs(F_parallel_net) > F_friction_max) {
                    // Thắng được ma sát nghỉ, bắt đầu chuyển động
                    const F_friction_kinetic = Math.sign(F_parallel_net) * F_friction_max;
                    const F_net = F_parallel_net - F_friction_kinetic;
                    a = F_net / m;
                }
            } else {
                // Vật đang chuyển động, ma sát trượt ngược chiều vận tốc
                const F_friction_kinetic = Math.sign(inclined_plane.v) * F_friction_max;
                a = (F_pull - F_gravity_parallel - F_friction_kinetic) / m;
            }

            // Chỉ cập nhật chuyển động nếu vật chưa ra khỏi mặt phẳng
            if (inclined_plane.s < planeLengthM && inclined_plane.s >= 0) {
                inclined_plane.v += a * timeStep * speed;
                inclined_plane.s += inclined_plane.v * timeStep * speed;
                inclined_plane.t += timeStep * speed;
            }
        }

        // --- Hiển thị công thức ---
        function showFormula() {
            let html = '';
            if (experiment === 'pendulum') {
                html = '\\( \\theta(t) = \\theta_0 \\cos\\left(\\sqrt{\\frac{g}{l}} t\\right) \\) &nbsp; &nbsp; \\( T = 2\\pi \\sqrt{\\frac{l}{g}} \\)';
            } else if (experiment === 'spring') {
                html = '\\( x(t) = A \\cos(\\omega t) \\), &nbsp; \\( \\omega = \\sqrt{\\frac{k}{m}} \\)';
            } else if (experiment === 'projectile') { // Công thức y đã được sửa
                html = '\\( x(t) = v_0 t \\), &nbsp; \\( y(t) = h_0 - \\frac{1}{2}gt^2 \\)';
            } else if (experiment === 'ideal_gas') {
                html = '\\( PV = nRT \\)';
            } else if (experiment === 'thermo') {
                html = '\\( Q = m c \\Delta T \\)';
            } else if (experiment === 'spring_horizontal') {
                html = '\\( F_{net} = -kx - F_{cản} \\), &nbsp; \\( x(t) = A e^{-\\frac{\\gamma t}{2}} \\cos(\\omega t) \\)';
            } else if (experiment === 'inclined_plane') {
                html = '\\( a = g(\\sin\\alpha - \\mu_t \\cos\\alpha) \\)';
            }
            document.getElementById('formula').innerHTML = html;
            if (window.MathJax) MathJax.typesetPromise();
        }

        // --- Tính toán phân bố Maxwell-Boltzmann ---
        function getMaxwellBoltzmannDistribution(T, M) {
            const R = 8.314;
            const k = 4 * Math.PI * Math.pow(M / (2 * Math.PI * R * T), 1.5);
            const exponent_factor = -M / (2 * R * T);
            
            let velocities = [];
            let probabilities = [];
            for (let v = 0; v <= 1500; v += 50) { // Vận tốc từ 0 đến 1500 m/s
                velocities.push(v);
                probabilities.push(k * v * v * Math.exp(exponent_factor * v * v));
            }
            return { velocities, probabilities };
        }

        // --- Hiển thị thông số ---
        function showInfo() {
            let html = '';
            if (experiment === 'pendulum') {
                let h = pendulum.length * (1 - Math.cos(pendulum.angle)); // Độ cao so với vị trí cân bằng
                let PE = pendulum.mass * pendulum.gravity * h; // Thế năng
                let v = pendulum.length * pendulum.aVel; // Vận tốc
                let KE = 0.5 * pendulum.mass * v * v; // Động năng
                let E = KE + PE;
                html = `
                    <b>Con lắc đơn:</b><br>
                    Góc hiện tại: ${(pendulum.angle * 180 / Math.PI).toFixed(2)}°<br>
                    Độ dài: ${pendulum.length.toFixed(2)} m<br>
                    Khối lượng: ${pendulum.mass} kg<br>
                    Vận tốc góc: ${pendulum.aVel.toFixed(3)} rad/s<br>
                    Gia tốc góc: ${pendulum.aAcc.toFixed(3)} rad/s²<br>
                    Chu kỳ: ${(2 * Math.PI * Math.sqrt(pendulum.length / pendulum.gravity)).toFixed(2)} s<br>
                    Động năng (KE): ${KE.toFixed(3)} J<br>
                    Thế năng (PE): ${PE.toFixed(3)} J<br>
                    Năng lượng (E): ${E.toFixed(3)} J
                `;
            } else if (experiment === 'spring') {
                let omega = Math.sqrt(spring.k / spring.mass);
                // Tính toán với biên độ tắt dần để khớp với đồ thị và mô phỏng
                let current_amplitude = spring.amplitude * Math.exp(-(spring.damping / (2 * spring.mass)) * spring.t);
                let x = current_amplitude * Math.cos(omega * spring.t);
                // Vận tốc cũng phải được tính từ đạo hàm của li độ tắt dần
                let v = -Math.exp(-(spring.damping / (2 * spring.mass)) * spring.t) * ( (spring.damping / (2 * spring.mass)) * spring.amplitude * Math.cos(omega * spring.t) + omega * spring.amplitude * Math.sin(omega * spring.t) );
                let KE = 0.5 * spring.mass * v * v; 
                let PE = 0.5 * spring.k * x * x;
                let E = KE + PE;
                html = `
                    <b>Lò xo:</b><br>
                    Thời gian: ${spring.t.toFixed(2)} s<br>
                    Độ cứng k: ${spring.k} N/m<br>
                    Khối lượng: ${spring.mass} kg<br>
                    Biên độ: ${spring.amplitude.toFixed(2)} m<br>
                    Tần số góc: ${omega.toFixed(2)} rad/s<br>
                    Vị trí x: ${x.toFixed(2)} m<br>
                    Vận tốc: ${v.toFixed(2)} m/s<br>
                    Động năng (KE): ${KE.toFixed(3)} J<br>
                    Thế năng (PE): ${PE.toFixed(3)} J<br>
                    Năng lượng (E): ${E.toFixed(3)} J
                `;
            } else if (experiment === 'projectile') {
                let t = projectile.t;
                const scale = 40;
                let current_h = (projectile.ground - projectile.y) / scale;
                let v_total = Math.sqrt(projectile.vx*projectile.vx + projectile.vy*projectile.vy);
                let KE = 0.5 * projectile.mass * v_total * v_total;
                let PE = projectile.mass * projectile.g * Math.max(0, current_h);
                html = `
                    <b>Ném ngang:</b><br>
                    Thời gian bay (t): ${t.toFixed(2)} s<br>
                    Tầm xa (x): ${(projectile.vx * t).toFixed(2)} m<br>
                    Độ cao (y): ${Math.max(0, current_h).toFixed(2)} m<br>
                    Vận tốc ngang (v_x): ${projectile.vx.toFixed(2)} m/s<br>
                    Vận tốc dọc (v_y): ${projectile.vy.toFixed(2)} m/s<br>
                    Động năng (KE): ${KE.toFixed(3)} J<br>
                    Thế năng (PE): ${PE.toFixed(3)} J<br>
                    Năng lượng (E): ${(KE + PE).toFixed(3)} J
                `;
            } else if (experiment === 'ideal_gas') {
                let v_avg = idealGas.T > 0 ? Math.sqrt(3 * idealGas.R * idealGas.T / (idealGas.M)) : 0;
                html = `
                    <b>Khí lý tưởng:</b><br>
                    Áp suất (P): ${(idealGas.P / 1000).toFixed(2)} kPa<br>
                    Thể tích (V): ${idealGas.V.toFixed(2)} m³<br>
                    Số mol (n): ${idealGas.n}<br>
                    Nhiệt độ (T): ${idealGas.T} K<br>
                    Số phân tử (mô phỏng): ${idealGas.molecules.length}<br>
                    Vận tốc trung bình phân tử: ${v_avg.toFixed(2)} m/s
                `;
            } else if (experiment === 'thermo') {
                let stateText = "Lỏng";
                if (thermo.state === 'SOLID') stateText = "Rắn (Nước đá)";
                else if (thermo.state === 'MELTING') stateText = `Nóng chảy (tại 0°C)`;
                else if (thermo.state === 'BOILING') stateText = `Sôi (tại 100°C)`;
                else if (thermo.state === 'GAS') stateText = "Khí (Hơi nước)";

                html = `
                    <b>Nhiệt động lực học:</b><br>
                    Nhiệt lượng trao đổi (Q): ${thermo.Q.toFixed(0)} J<br>
                    Nhiệt độ hiện tại (T): ${thermo.T.toFixed(2)} °C<br>
                    Trạng thái: <strong>${stateText}</strong><br>
                    ---<br>
                    Khối lượng vật (m): ${thermo.m} kg<br>
                    Khối lượng bình (m_b): ${thermo.m_container} kg<br>
                    Nhiệt dung riêng bình (c_b): ${thermo.c_container} J/kg.K<br>
                    Nhiệt dung riêng nước (c_n): ${thermo.c_water} J/kg.K
                `;
            } else if (experiment === 'spring_horizontal') {
                let omega = Math.sqrt(spring_horizontal.k / spring_horizontal.mass);
                // Tính toán với biên độ tắt dần để khớp với đồ thị và mô phỏng
                let current_amplitude = spring_horizontal.amplitude * Math.exp(-(spring_horizontal.damping / (2 * spring_horizontal.mass)) * spring_horizontal.t);
                let x = current_amplitude * Math.cos(omega * spring_horizontal.t);
                // Vận tốc cũng phải được tính từ đạo hàm của li độ tắt dần
                let v = -Math.exp(-(spring_horizontal.damping / (2 * spring_horizontal.mass)) * spring_horizontal.t) * ( (spring_horizontal.damping / (2 * spring_horizontal.mass)) * spring_horizontal.amplitude * Math.cos(omega * spring_horizontal.t) + omega * spring_horizontal.amplitude * Math.sin(omega * spring_horizontal.t) );
                let KE = 0.5 * spring_horizontal.mass * v * v; 
                let PE = 0.5 * spring_horizontal.k * x * x;
                let E = KE + PE;
                html = `
                    <b>Con lắc lò xo ngang:</b><br>
                    Thời gian: ${(spring_horizontal.t).toFixed(2)} s<br>
                    Độ cứng k: ${spring_horizontal.k} N/m<br>
                    Khối lượng: ${spring_horizontal.mass} kg<br>
                    Biên độ: ${spring_horizontal.amplitude.toFixed(2)} m<br>
                    Vị trí x: ${x.toFixed(2)} m<br>
                    Vận tốc: ${v.toFixed(2)} m/s<br>
                    Động năng (KE): ${KE.toFixed(3)} J<br>
                    Thế năng (PE): ${PE.toFixed(3)} J<br>
                    Năng lượng (E): ${E.toFixed(3)} J
                `;
            } else if (experiment === 'inclined_plane') {
                let rad = inclined_plane.angle * Math.PI / 180;
                const F_net = inclined_plane.F_pull - inclined_plane.mass * inclined_plane.g * Math.sin(rad) - Math.sign(inclined_plane.v) * inclined_plane.friction * inclined_plane.mass * inclined_plane.g * Math.cos(rad);
                let a = F_net / inclined_plane.mass;

                let h = inclined_plane.s * Math.sin(rad); // Độ cao hiện tại so với chân mặt phẳng nghiêng
                let KE = 0.5 * inclined_plane.mass * Math.pow(inclined_plane.v, 2);
                let PE = inclined_plane.mass * inclined_plane.g * h;
                let F_g_parallel = inclined_plane.mass * inclined_plane.g * Math.sin(rad);
                html = `
                    <b>Mặt phẳng nghiêng:</b><br>
                    Thời gian: ${inclined_plane.t.toFixed(2)} s<br>
                    Góc nghiêng: ${inclined_plane.angle}°<br>
                    Khối lượng: ${inclined_plane.mass} kg<br>
                    Gia tốc: ${a.toFixed(2)} m/s²<br>
                    Vận tốc: ${inclined_plane.v.toFixed(2)} m/s<br>
                    Quãng đường: ${inclined_plane.s.toFixed(2)} m<br>
                    Lực kéo: ${inclined_plane.F_pull.toFixed(2)} N<br>
                    Thành phần &parallel; của trọng lực: ${F_g_parallel.toFixed(2)} N<br>
                    Động năng (KE): ${KE.toFixed(3)} J<br>
                    Thế năng (PE): ${PE.toFixed(3)} J<br>
                    Năng lượng (E): ${(KE+PE).toFixed(3)} J
                `;
            }
            document.getElementById('info').innerHTML = html;
        }
        

        // --- Hiển thị điều chỉnh thông số ---
        function showParams() {
            let html = '';
            if (experiment === 'pendulum') {
                html = ` 
                    <div class="param-item"><span class="slider-label">Góc ban đầu (°):</span><input type="range" id="angle" min="5" max="80" value="30" oninput="document.getElementById('angle_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="angle_val">30</span></div>
                    <div class="param-item"><span class="slider-label">Độ dài (m):</span><input type="range" id="length" min="0.2" max="2" step="0.01" value="1" oninput="document.getElementById('length_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="length_val">1</span></div>
                    <div class="param-item"><span class="slider-label">Lực cản:</span><input type="range" id="damping" min="0" max="0.5" step="0.01" value="0.1" oninput="document.getElementById('damping_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="damping_val">0.1</span></div>
                    <div class="param-item"><span class="slider-label">Khối lượng (kg):</span><input type="range" id="mass" min="0.05" max="2" step="0.01" value="0.2" oninput="document.getElementById('mass_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="mass_val">0.2</span></div>
                `;
            } else if (experiment === 'spring') {
                html = `
                    <div class="param-item"><span class="slider-label">Độ cứng k (N/m):</span><input type="range" id="k" min="5" max="50" step="1" value="20" oninput="document.getElementById('k_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="k_val">20</span></div>
                    <div class="param-item"><span class="slider-label">Khối lượng (kg):</span><input type="range" id="mass" min="0.1" max="2" step="0.01" value="0.5" oninput="document.getElementById('mass_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="mass_val">0.5</span></div>
                    <div class="param-item"><span class="slider-label">Biên độ (m):</span><input type="range" id="amplitude" min="0.05" max="0.5" step="0.01" value="0.2" oninput="document.getElementById('amplitude_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="amplitude_val">0.2</span></div>
                    <div class="param-item"><span class="slider-label">Lực cản:</span><input type="range" id="damping" min="0" max="1" step="0.01" value="0.2" oninput="document.getElementById('damping_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="damping_val">0.2</span></div>
                `;
            } else if (experiment === 'projectile') {
                html = `
                    <div class="param-item"><span class="slider-label">Vận tốc ném ngang (m/s):</span><input type="range" id="vx" min="2" max="20" step="0.1" value="10" oninput="document.getElementById('vx_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="vx_val">10</span></div>
                    <div class="param-item"><span class="slider-label">Độ cao ban đầu (m):</span><input type="range" id="y" min="1" max="10" step="0.1" value="4" oninput="document.getElementById('y_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="y_val">4</span></div>
                    <div class="param-item"><span class="slider-label">Lực cản:</span><input type="range" id="damping" min="0" max="0.1" step="0.001" value="0.01" oninput="document.getElementById('damping_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="damping_val">0.01</span></div>
                    <div class="param-item"><span class="slider-label">Khối lượng (kg):</span><input type="range" id="mass" min="0.05" max="1" step="0.01" value="0.1" oninput="document.getElementById('mass_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="mass_val">0.1</span></div>
                `;
            } else if (experiment === 'ideal_gas') {
                html = `
                    <div class="param-item"><span class="slider-label">Thể tích (m³):</span><input type="range" id="V" min="0.01" max="0.1" step="0.001" value="0.0224" oninput="idealGas.V=parseFloat(this.value); idealGas.P=(idealGas.n*idealGas.R*idealGas.T)/idealGas.V; document.getElementById('V_val').innerText=this.value;"><span class="slider-value" id="V_val">0.0224</span></div>
                    <div class="param-item"><span class="slider-label">Số mol (mol):</span><input type="range" id="n" min="0.5" max="5" step="0.1" value="1" oninput="document.getElementById('n_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="n_val">1</span></div>
                    <div class="param-item"><span class="slider-label">Nhiệt độ (K):</span><input type="range" id="T" min="0" max="600" step="1" value="273" oninput="document.getElementById('T_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="T_val">273</span></div>
                `;
            } else if (experiment === 'thermo') {
                html = `
                    <div class="param-item"><span class="slider-label">Khối lượng vật (kg):</span><input type="range" id="m" min="0.1" max="5" step="0.1" value="1" oninput="document.getElementById('m_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="m_val">1</span></div>
                    <div class="param-item"><span class="slider-label">Khối lượng bình (kg):</span><input type="range" id="m_container" min="0.1" max="2" step="0.1" value="0.5" oninput="document.getElementById('m_container_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="m_container_val">0.5</span></div>
                    <div class="param-item"><span class="slider-label">Nhiệt độ ban đầu (°C):</span><input type="range" id="T0" min="-50" max="50" step="1" value="25" oninput="document.getElementById('T0_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="T0_val">25</span></div>
                    <div class="param-item"><span class="slider-label">Nhiệt dung riêng bình (J/kg.K):</span><input type="range" id="c_container" min="300" max="1000" step="10" value="900" oninput="document.getElementById('c_container_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="c_container_val">900</span></div>
                `;
            } else if (experiment === 'spring_horizontal') {
                html = `
                    <div class="param-item"><span class="slider-label">Độ cứng k (N/m):</span><input type="range" id="k" min="5" max="50" step="1" value="20" oninput="document.getElementById('k_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="k_val">20</span></div>
                    <div class="param-item"><span class="slider-label">Khối lượng (kg):</span><input type="range" id="mass" min="0.1" max="2" step="0.01" value="0.5" oninput="document.getElementById('mass_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="mass_val">0.5</span></div>
                    <div class="param-item"><span class="slider-label">Biên độ (m):</span><input type="range" id="amplitude" min="0.05" max="0.5" step="0.01" value="0.2" oninput="document.getElementById('amplitude_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="amplitude_val">0.2</span></div>
                    <div class="param-item"><span class="slider-label">Lực cản:</span><input type="range" id="damping" min="0" max="1" step="0.01" value="0.2" oninput="document.getElementById('damping_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="damping_val">0.2</span></div>
                `;
            } else if (experiment === 'inclined_plane') {
                html = `
                    <div class="param-item"><span class="slider-label">Góc nghiêng (°):</span><input type="range" id="angle" min="5" max="60" value="30" oninput="document.getElementById('angle_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="angle_val">30</span></div>
                    <div class="param-item"><span class="slider-label">Hệ số ma sát:</span><input type="range" id="friction" min="0" max="0.6" step="0.01" value="0.1" oninput="document.getElementById('friction_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="friction_val">0.1</span></div>
                    <div class="param-item"><span class="slider-label">Khối lượng (kg):</span><input type="range" id="mass" min="0.1" max="5" step="0.1" value="1" oninput="document.getElementById('mass_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="mass_val">1</span></div>
                    <div class="param-item"><span class="slider-label">Lực kéo (N):</span><input type="range" id="F_pull" min="0" max="50" step="0.1" value="0" oninput="document.getElementById('F_pull_val').innerText=this.value; resetExperiment()"><span class="slider-value" id="F_pull_val">0</span></div>
                `;
            }
            document.getElementById('params').innerHTML = html;
        }

        function resetExperiment() {
            if (experiment === 'pendulum') {
                pendulum.angle = (parseFloat(document.getElementById('angle').value) || 30) * Math.PI / 180;
                pendulum.length = parseFloat(document.getElementById('length').value) || 1;
                pendulum.mass = parseFloat(document.getElementById('mass').value) || 0.2;
                pendulum.damping = parseFloat(document.getElementById('damping').value) || 0.1;
                pendulum.aVel = 0;
                pendulum.aAcc = 0;
            } else if (experiment === 'spring') {
                spring.k = parseFloat(document.getElementById('k').value) || 20;
                spring.mass = parseFloat(document.getElementById('mass').value) || 0.5;
                spring.amplitude = parseFloat(document.getElementById('amplitude').value) || 0.2;
                spring.damping = parseFloat(document.getElementById('damping').value) || 0.2;
                spring.t = 0;
            } else if (experiment === 'projectile') {
                projectile.vx = parseFloat(document.getElementById('vx').value) || 10;
                projectile.h0 = parseFloat(document.getElementById('y').value) || 4;
                projectile.mass = parseFloat(document.getElementById('mass').value) || 0.1;
                projectile.damping = parseFloat(document.getElementById('damping').value) || 0.01;
                projectile.t = 0;
                projectile.x = 60;
                projectile.y = projectile.ground - projectile.h0 * 40;
                projectile.vy = 0;
            } else if (experiment === 'ideal_gas') {
                idealGas.V = parseFloat(document.getElementById('V').value) || 0.0224;
                idealGas.n = parseFloat(document.getElementById('n').value) || 1;
                idealGas.T = parseFloat(document.getElementById('T').value) || 273;
                idealGas.P = (idealGas.n * idealGas.R * idealGas.T) / idealGas.V;
                initMolecules();
            } else if (experiment === 'thermo') {
                thermo.m = parseFloat(document.getElementById('m').value) || 1;
                thermo.m_container = parseFloat(document.getElementById('m_container').value) || 0.5;
                thermo.c_container = parseFloat(document.getElementById('c_container').value) || 900;
                thermo.T0 = parseFloat(document.getElementById('T0').value) || 25;
                thermo.T = thermo.T0;
                thermo.Q = 0;
                thermo.t = 0;
                thermo.state = thermo.T < 0 ? 'SOLID' : (thermo.T < 100 ? 'LIQUID' : 'GAS');
                if (thermo.T === 0) thermo.state = 'MELTING';
            } else if (experiment === 'spring_horizontal') {
                spring_horizontal.k = parseFloat(document.getElementById('k').value) || 20;
                spring_horizontal.mass = parseFloat(document.getElementById('mass').value) || 0.5;
                spring_horizontal.amplitude = parseFloat(document.getElementById('amplitude').value) || 0.2;
                spring_horizontal.damping = parseFloat(document.getElementById('damping').value) || 0.2;
                spring_horizontal.t = 0;
            } else if (experiment === 'inclined_plane') {
                inclined_plane.angle = parseFloat(document.getElementById('angle').value) || 30;
                inclined_plane.mass = parseFloat(document.getElementById('mass').value) || 1;
                inclined_plane.friction = parseFloat(document.getElementById('friction').value) || 0.1;
                inclined_plane.F_pull = parseFloat(document.getElementById('F_pull').value) || 0;
                inclined_plane.s = 0;
                inclined_plane.v = 0;
                inclined_plane.t = 0;
                // Thêm dòng này để đặt lại vị trí vẽ của vật
                const startX = 150, startY = 400;
                let rad = inclined_plane.angle * Math.PI / 180;
                inclined_plane.x = startX; // Đặt lại tọa độ x, y để vẽ
                inclined_plane.y = startY; // (Mặc dù không dùng trực tiếp nhưng để cho đầy đủ)
            }
        }

        function changeExperiment() {
            experiment = document.getElementById('experiment').value;
            setupChartForExperiment(); // Thêm dòng này để khởi tạo lại biểu đồ đúng loại
            showParams();
            // Hiển thị/ẩn nút nhiệt dựa trên thí nghiệm
            const heatBtn = document.getElementById('heatBtn');
            if (heatBtn) heatBtn.style.display = (experiment === 'thermo') ? 'inline-flex' : 'none';

            resetExperiment();
            showFormula();
        }
        
        function togglePause() {
            isPaused = !isPaused;
            const pauseBtnText = document.querySelector('#pauseBtn .btn-text');
            const playIcon = document.getElementById('playIcon'); // Có thể không tồn tại nếu bạn xóa btn-text
            const pauseIcon = document.getElementById('pauseIcon'); // Có thể không tồn tại nếu bạn xóa btn-text
            if (pauseBtnText) pauseBtnText.innerText = isPaused ? 'Tiếp tục' : 'Tạm dừng';
            if (playIcon) playIcon.style.display = isPaused ? 'inline' : 'none';
            if (pauseIcon) pauseIcon.style.display = isPaused ? 'none' : 'inline';

        }

        function speedUp() {
            speed *= 2;
            if (speed > 16) speed = 16;
            document.getElementById('speedIndicator').innerText = 'x' + speed;
        }

        function speedDown() {
            speed /= 2;
            if (speed < 0.25) speed = 0.25;
            document.getElementById('speedIndicator').innerText = 'x' + speed;
        }

        function toggleHeating() {
            thermo.heating = !thermo.heating;
            const heatBtn = document.getElementById('heatBtn');
            heatBtn.title = thermo.heating ? 'Tắt lửa' : 'Bật lửa';
            // Thêm/xóa class để thay đổi style thay vì inline style
            if (thermo.heating) heatBtn.classList.add('active-fire');
            else heatBtn.classList.remove('active-fire');
            if (thermo.heating) thermo.lastUpdate = Date.now();
        }

        function changeTheme(themeClass) {
            document.body.className = themeClass;
            // Cập nhật class 'active' cho theme dot
            document.querySelectorAll('.theme-dot').forEach(dot => {
                dot.classList.remove('active');
            });
            const activeDot = document.getElementById(themeClass);
            if (activeDot) activeDot.classList.add('active');
            saveState(); // Lưu trạng thái sau khi đổi theme
        }

        // --- Cập nhật màu thanh trượt ---
        function updateSliderFill(slider) {
            const min = slider.min || 0;
            const max = slider.max || 100;
            const val = slider.value;
            const percentage = ((val - min) / (max - min)) * 100;
            slider.style.backgroundSize = `${percentage}% 100%`;
        }

        // --- Lưu và Tải Trạng thái ---
        const STATE_KEY = 'virtualLabState';

        function saveState() {
            const paramsToSave = {};
            document.querySelectorAll('#params input[type="range"]').forEach(slider => {
                paramsToSave[slider.id] = slider.value;
            });

            const state = {
                theme: document.body.className,
                experiment: document.getElementById('experiment').value,
                params: paramsToSave
            };
            localStorage.setItem(STATE_KEY, JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem(STATE_KEY);
            if (!savedState) {
                changeExperiment(); // Nếu không có gì, chạy mặc định
                return;
            }
            const state = JSON.parse(savedState);
            document.body.className = state.theme || 'theme-default';
            // Cập nhật theme dot active
            document.querySelectorAll('.theme-dot').forEach(dot => dot.classList.remove('active'));
            const activeDot = document.getElementById(state.theme || 'theme-default');
            if (activeDot) activeDot.classList.add('active');

            document.getElementById('experiment').value = state.experiment || 'pendulum';
            changeExperiment(false); // Tải thí nghiệm nhưng không lưu lại ngay

            // Áp dụng lại các giá trị slider đã lưu
            if (state.params) {
                for (const paramId in state.params) {
                    const slider = document.getElementById(paramId);
                    if (slider) {
                        slider.value = state.params[paramId];
                        const valueSpan = document.getElementById(paramId + '_val');
                        if (valueSpan) valueSpan.innerText = slider.value;
                        updateSliderFill(slider);
                    }
                }
                resetExperiment(); // Áp dụng các giá trị vừa set vào mô phỏng
            }
        }

        // --- Chart Functions ---
        function initChart() {
            const chartCanvas = document.getElementById('energyChart').getContext('2d');
            energyChart = new Chart(chartCanvas, {
                type: 'line',
                // Giữ nguyên cấu trúc biểu đồ, chỉ thay đổi màu sắc
                data: {
                    labels: chartData.labels,
                    datasets: [
                        { label: 'Động năng (KE)', data: chartData.KE, borderColor: '#4caf50', fill: false, borderWidth: 2, pointRadius: 0 },
                        { label: 'Thế năng (PE)', data: chartData.PE, borderColor: '#2196f3', fill: false, borderWidth: 2, pointRadius: 0 },
                        { label: 'Cơ năng (E)', data: chartData.E, borderColor: '#ff9800', fill: false, borderWidth: 2, pointRadius: 0, borderDash: [5, 5] }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    animation: false,
                    hover: {
                        animationDuration: 0 // Tắt animation khi hover
                    },
                    title: { display: true, text: 'Biểu đồ Năng lượng', fontColor: 'var(--text-color)' },
                    scales: {
                        xAxes: [{ ticks: { fontColor: 'var(--text-color)' }, gridLines: { color: 'var(--border-color)' } }],
                        yAxes: [{ ticks: { fontColor: 'var(--text-color)' }, gridLines: { color: 'var(--border-color)' }, scaleLabel: { display: true, labelString: 'Năng lượng (J)', fontColor: 'var(--text-color)' } }]
                    },
                    legend: { labels: { fontColor: 'var(--text-color)' } }
                }
            });
        }

        function updateChartData() {
            let KE = 0, PE = 0, E = 0;
            const MAX_POINTS = 200;
            // Tự động ẩn/hiện các đường dữ liệu nếu chúng không có giá trị
            energyChart.data.datasets.forEach((dataset, index) => {
                const isVisible = dataset.data.some(val => val !== 0 && val !== null && val !== undefined);
                energyChart.setDatasetVisibility(index, isVisible);
            });

            if (['pendulum', 'spring', 'spring_horizontal', 'projectile', 'inclined_plane'].includes(experiment) && energyChart.config.type === 'line') {
                const infoHtml = document.getElementById('info').innerHTML;
                const keMatch = infoHtml.match(/Động năng \(KE\): ([\d.-]+) J/);
                const peMatch = infoHtml.match(/Thế năng \(PE\): ([\d.-]+) J/);
                if (keMatch) KE = parseFloat(keMatch[1]);
                if (peMatch) PE = parseFloat(peMatch[1]);
                E = KE + PE;

                chartData.KE.push(KE);
                chartData.PE.push(PE);
                chartData.E.push(E);
                chartData.labels.push('');

                if (chartData.KE.length > MAX_POINTS) {
                    chartData.KE.shift();
                    chartData.PE.shift();
                    chartData.E.shift();
                    chartData.labels.shift();
                }
                energyChart.data.datasets[0].data = chartData.KE;
                energyChart.data.datasets[1].data = chartData.PE;
                energyChart.data.datasets[2].data = chartData.E;
                energyChart.data.labels = chartData.labels;

            } else if (experiment === 'ideal_gas' && energyChart.config.type === 'bar') {
                // ... (logic cho biểu đồ khí lý tưởng không đổi)
                const v_rms = Math.sqrt(3 * idealGas.R * idealGas.T / idealGas.M);
                const sim_v_avg = Math.sqrt(idealGas.T) * 0.1 * Math.sqrt(2 * (0.5**2)/2); // RMS của (rand-0.5)
                const scalingFactor = v_rms / (sim_v_avg * Math.sqrt(2)); // Heuristic scaling

                const speeds = idealGas.molecules.map(m => Math.sqrt(m.vx*m.vx + m.vy*m.vy) * scalingFactor);
                const bins = new Array(30).fill(0); // 30 bins, mỗi bin 50 m/s
                speeds.forEach(s => {
                    const binIndex = Math.floor(s / 50);
                    if (binIndex < bins.length) {
                        bins[binIndex]++;
                    }
                });
                // Chuẩn hóa histogram
                const totalMolecules = idealGas.molecules.length;
                const normalizedBins = bins.map(count => count / totalMolecules);

                // Lấy đường cong lý thuyết
                const { velocities, probabilities } = getMaxwellBoltzmannDistribution(idealGas.T, idealGas.M);
                
                energyChart.data.datasets[0].data = normalizedBins; // Histogram
                energyChart.data.datasets[1].data = probabilities; // Lý thuyết
                energyChart.data.labels = velocities.map(v => v);
            } else if (experiment === 'thermo' && energyChart.config.type === 'line') {
                chartData.T.push(thermo.T);
                chartData.labels.push(thermo.t.toFixed(1));

                if (chartData.T.length > MAX_POINTS) {
                    chartData.T.shift();
                    chartData.labels.shift();
                }
                energyChart.data.datasets[0].data = chartData.T;
                energyChart.data.labels = chartData.labels;
            }
            
            energyChart.update({ duration: 0 });
        }

        function setupChartForExperiment() {
            if (energyChart) energyChart.destroy();
            const chartCanvas = document.getElementById('energyChart').getContext('2d');

            if (experiment === 'ideal_gas') {
                chartData = {}; // Dữ liệu cho biểu đồ này được tạo riêng
                initMaxwellChart(chartCanvas);
            } else if (experiment === 'thermo') {
                chartData = { T: [], labels: [] }; // Dữ liệu nhiệt độ
                initTemperatureChart(chartCanvas);
            } else { // Default to energy chart
                chartData = { KE: [], PE: [], E: [], labels: [] }; // Dữ liệu năng lượng
                initEnergyChart(chartCanvas);
            }
        }

        function initEnergyChart(canvas) {
            initChart(); // Tên hàm cũ, giờ chỉ dùng cho năng lượng
        }
        function initMaxwellChart(canvas) {
            energyChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: [], // Vận tốc (m/s)
                    datasets: [
                        {
                            label: 'Phân bố thực tế (Mô phỏng)',
                            data: [],
                            backgroundColor: 'rgba(230, 126, 34, 0.6)',
                            borderColor: '#e67e22',
                            borderWidth: 1
                        },
                        {
                            label: 'Phân bố lý thuyết (Maxwell-Boltzmann)',
                            data: [],
                            type: 'line',
                            borderColor: '#ffd54f',
                            fill: false,
                            borderWidth: 2,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    title: { display: true, text: 'Phân bố vận tốc phân tử', fontColor: 'var(--text-color)' },
                    scales: {
                        xAxes: [{ scaleLabel: { display: true, labelString: 'Vận tốc (m/s)', fontColor: 'var(--text-color)' }, ticks: { fontColor: 'var(--text-color)' }, gridLines: { color: 'var(--border-color)' } }],
                        yAxes: [{ scaleLabel: { display: true, labelString: 'Xác suất', fontColor: 'var(--text-color)' }, ticks: { fontColor: 'var(--text-color)', beginAtZero: true }, gridLines: { color: 'var(--border-color)' } }]
                    },
                    legend: { labels: { fontColor: 'var(--text-color)' } }
                }
            });
        }

        function initTemperatureChart(canvas) {
            energyChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Nhiệt độ',
                        data: chartData.T,
                        borderColor: '#ff6384',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    title: { display: true, text: 'Biểu đồ Nhiệt độ', fontColor: 'var(--text-color)' },
                    scales: {
                        xAxes: [{ scaleLabel: { display: true, labelString: 'Thời gian (s)', fontColor: 'var(--text-color)' }, ticks: { fontColor: 'var(--text-color)' }, gridLines: { color: 'var(--border-color)' } }],
                        yAxes: [{ scaleLabel: { display: true, labelString: 'Nhiệt độ (°C)', fontColor: 'var(--text-color)' }, ticks: { fontColor: 'var(--text-color)' }, gridLines: { color: 'var(--border-color)' } }]
                    },
                    legend: { labels: { fontColor: 'var(--text-color)' } }
                }
            });
        }

        function animate() {
            if (!isPaused) {
                let updateCount = Math.max(1, Math.floor(speed));
                for (let i = 0; i < updateCount; i++) {
                    if (experiment === 'pendulum') updatePendulum();
                    else if (experiment === 'spring') updateSpring();
                    else if (experiment === 'projectile') updateProjectile();
                    else if (experiment === 'ideal_gas') updateIdealGas();
                    else if (experiment === 'thermo') updateThermo();
                    else if (experiment === 'spring_horizontal') updateSpringHorizontal();
                    else if (experiment === 'inclined_plane') updateInclinedPlane();
                }
            }
            if (experiment === 'pendulum') drawPendulum();
            else if (experiment === 'spring') drawSpring();
            else if (experiment === 'projectile') drawProjectile();
            else if (experiment === 'ideal_gas') drawIdealGas();
            else if (experiment === 'thermo') drawThermo();
            else if (experiment === 'spring_horizontal') drawSpringHorizontal();
            else if (experiment === 'inclined_plane') drawInclinedPlane();
            showInfo();
            if (!isPaused) {
                checkAndPause(); // Thêm kiểm tra điều kiện dừng
                updateChartData();
            }
            requestAnimationFrame(animate);
        }

        function checkAndPause() {
            if (isPaused) return;

            let stopped = false;
            const VELOCITY_THRESHOLD = 0.001;
            const POSITION_THRESHOLD = 0.001;

            if (experiment === 'pendulum') {
                stopped = Math.abs(pendulum.aVel) < VELOCITY_THRESHOLD && Math.abs(pendulum.angle) < POSITION_THRESHOLD;
            } else if (experiment === 'spring' || experiment === 'spring_horizontal') {
                const s = experiment === 'spring' ? spring : spring_horizontal;
                const current_amplitude = s.amplitude * Math.exp(-(s.damping / (2 * s.mass)) * s.t);
                stopped = current_amplitude < 0.001;
            } else if (experiment === 'projectile') {
                stopped = projectile.y + projectile.radius >= projectile.ground;
            }
            if (stopped) togglePause();
        }

        // --- Khởi chạy ---
        loadState(); // Thay vì chạy mặc định, hãy tải trạng thái đã lưu
        animate();
        // Thêm event listener để cập nhật màu thanh trượt khi người dùng tương tác
        document.getElementById('params').addEventListener('input', function(e) {
            if (e.target.type === 'range') {
                updateSliderFill(e.target);
                saveState(); // Lưu trạng thái mỗi khi slider thay đổi
            }
        });

        // Sidebar toggle for mobile
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarToggle.querySelector('.icon').innerHTML = sidebar.classList.contains('open') 
                ? '<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>' 
                : '<path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>';
        });
        document.querySelector('.main-content').addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarToggle.querySelector('.icon').innerHTML = '<path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>';
        });
    </script>
</body>
</html>
Một số tính năng còn chưa hoàn thiện! Mình sẽ tiếp tục cập nhật trong thời gian tới.
